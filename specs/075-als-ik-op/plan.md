# Implementation Plan: Fix Free Trial 401 Unauthorized Error

**Branch**: `075-als-ik-op` | **Date**: 2025-12-19 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/075-als-ik-op/spec.md`

## Summary
Fix the 401 Unauthorized error that occurs when unauthenticated visitors click "Start Free Trial" on the subscription page. The solution redirects unauthenticated users to login, stores their plan selection, and auto-confirms after authentication.

## Technical Context
**Language/Version**: JavaScript (ES6+), Node.js
**Primary Dependencies**: Express.js, Vanilla JavaScript frontend
**Storage**: PostgreSQL (Neon) for users/subscriptions, sessionStorage for pending selections
**Testing**: Manual browser testing, API endpoint testing via curl
**Target Platform**: Web browsers (Chrome, Firefox, Safari, Edge)
**Project Type**: Web application (monolith with public/ frontend and server.js backend)
**Performance Goals**: Immediate UI response, <500ms redirect
**Constraints**: Must work offline for sessionStorage, all UI text in English
**Scale/Scope**: Single subscription page, ~3 JavaScript files affected

## Constitution Check
*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Beta Freeze | ✅ PASS | Changes deploy to staging only |
| II. Staging-First | ✅ PASS | Will test on dev.tickedify.com |
| III. Sub-Agents | ✅ PASS | Bug fix - using tickedify-bug-hunter would be appropriate |
| IV. Version & Changelog | ✅ PASS | Will bump version and update changelog |
| V. Deployment Verification | ✅ PASS | Will verify via /api/version endpoint |
| VI. Test-First API | ✅ PASS | Can test via direct API calls |

## Project Structure

### Documentation (this feature)
```
specs/075-als-ik-op/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Root cause analysis ✅
├── data-model.md        # sessionStorage schema ✅
├── quickstart.md        # Test scenarios ✅
├── contracts/           # Behavior contracts ✅
│   └── subscription-unauthenticated-flow.md
└── tasks.md             # Generated by /tasks command
```

### Source Code Changes
```
public/js/
├── subscription.js      # Main changes: confirmSelection(), initializeSubscriptionPage()
├── subscription-api.js  # Minor: improve error handling
└── subscription-data.js # No changes needed

server.js                # No backend changes required
```

## Phase 0: Outline & Research ✅ COMPLETE
See [research.md](./research.md)

**Key Findings**:
- Root cause: `/api/subscription/select` requires authentication but subscription page is public
- Solution: Frontend detects unauthenticated state, stores selection, redirects to login
- No backend changes required - existing endpoint behavior is correct

## Phase 1: Design & Contracts ✅ COMPLETE

**Artifacts Created**:
- [data-model.md](./data-model.md) - sessionStorage schema for pending selections
- [contracts/subscription-unauthenticated-flow.md](./contracts/subscription-unauthenticated-flow.md) - Expected behavior
- [quickstart.md](./quickstart.md) - Test scenarios and verification checklist
- CLAUDE.md updated via script

## Phase 2: Task Planning Approach
*Describes what the /tasks command will do*

**Task Generation Strategy**:
1. **Authentication detection task** - Modify `initializeSubscriptionPage()` to set `isAuthenticated` flag
2. **Pending selection storage task** - Add functions to store/retrieve from sessionStorage
3. **confirmSelection modification task** - Check auth before API call, redirect if needed
4. **Post-login detection task** - Check for pending selection on page load
5. **Auto-confirm task** - Automatically confirm stored selection after login
6. **Error message task** - Ensure all messages are in English

**Ordering Strategy**:
- Storage utilities first (independent)
- Auth detection second (used by confirm flow)
- confirmSelection changes third (main fix)
- Auto-confirm fourth (uses storage utilities)
- Error messages last (polish)

**Estimated Output**: 6-8 tasks, straightforward bug fix

## Complexity Tracking
*No violations - simple frontend fix*

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| None | N/A | N/A |

## Progress Tracking

**Phase Status**:
- [x] Phase 0: Research complete (/plan command)
- [x] Phase 1: Design complete (/plan command)
- [x] Phase 2: Task planning complete (/plan command - describe approach only)
- [x] Phase 3: Tasks generated (/tasks command) - 18 tasks in tasks.md
- [ ] Phase 4: Implementation complete
- [ ] Phase 5: Validation passed

**Gate Status**:
- [x] Initial Constitution Check: PASS
- [x] Post-Design Constitution Check: PASS
- [x] All NEEDS CLARIFICATION resolved
- [x] Complexity deviations documented (none needed)

---
*Based on Constitution v1.0.1 - See `.specify/memory/constitution.md`*
