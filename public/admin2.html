<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Admin Dashboard v2 - Tickedify</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Admin Dashboard v2 Specific Styles */
        .admin-layout {
            display: flex;
            height: 100vh;
            background: var(--macos-bg-primary);
        }

        .admin-sidebar {
            width: 250px;
            background: var(--macos-bg-secondary);
            border-right: 1px solid var(--macos-border);
            padding: 20px;
            overflow-y: auto;
        }

        .admin-sidebar-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--macos-blue);
        }

        .admin-sidebar-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--macos-blue);
            margin-bottom: 5px;
        }

        .admin-sidebar-subtitle {
            font-size: 12px;
            color: var(--macos-text-secondary);
        }

        .admin-nav {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .admin-nav-item {
            margin-bottom: 5px;
        }

        .admin-nav-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--macos-text-primary);
            text-decoration: none;
            border-radius: var(--macos-radius-medium);
            transition: all 0.2s;
            font-size: 14px;
        }

        .admin-nav-link:not(.active):hover {
            background: var(--macos-bg-hover);
        }

        .admin-nav-link.active {
            background: var(--macos-blue);
            color: white;
            font-weight: 600;
        }

        .admin-nav-link.active .admin-nav-icon {
            filter: brightness(0) invert(1);
        }

        .admin-nav-icon {
            margin-right: 10px;
            font-size: 16px;
        }

        .admin-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .admin-screen {
            display: none;
        }

        .admin-screen.active {
            display: block;
        }

        .admin-header {
            margin-bottom: 30px;
        }

        .admin-header-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--macos-text-primary);
            margin-bottom: 5px;
        }

        .admin-header-subtitle {
            font-size: 14px;
            color: var(--macos-text-secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--macos-bg-secondary);
            border-radius: var(--macos-radius-medium);
            padding: 20px;
            border-left: 4px solid var(--macos-blue);
        }

        .stat-label {
            font-size: 12px;
            color: var(--macos-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--macos-text-primary);
        }

        .stat-subtext {
            font-size: 12px;
            color: var(--macos-text-secondary);
            margin-top: 5px;
        }

        .sparkline-container {
            margin-top: 15px;
            height: 40px;
            position: relative;
        }

        .sparkline-container canvas {
            width: 100% !important;
            height: 40px !important;
            pointer-events: none;  /* Allow clicks to pass through to parent card */
        }

        .admin-table {
            width: 100%;
            background: var(--macos-bg-secondary);
            border-radius: var(--macos-radius-medium);
            overflow: hidden;
        }

        .admin-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-table th {
            background: var(--macos-bg-tertiary);
            padding: 12px 15px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--macos-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .admin-table td {
            padding: 15px;
            border-top: 1px solid var(--macos-border);
            font-size: 14px;
        }

        .admin-table tr:hover {
            background: var(--macos-bg-hover);
        }

        /* Enhanced Loading Spinner (T043) */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--macos-border);
            border-top-color: var(--macos-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: var(--macos-radius-medium);
            border-left: 4px solid #c33;
            margin-bottom: 20px;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--macos-border);
            border-radius: var(--macos-radius-medium);
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--macos-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .search-help {
            font-size: 12px;
            color: var(--macos-text-secondary);
            margin-top: 5px;
        }

        .user-search-row {
            cursor: pointer;
        }

        .user-search-row:hover {
            background: var(--macos-bg-hover);
        }

        .status-active {
            color: #34C759;
            font-weight: 600;
        }

        .status-inactive {
            color: #FF3B30;
            font-weight: 600;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--macos-radius-medium);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--macos-blue);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-danger {
            background: #c33;
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .chart-container {
            background: var(--macos-bg-secondary);
            border-radius: var(--macos-radius-medium);
            padding: 20px;
            margin-bottom: 30px;
        }

        /* Badge Styling */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .badge-primary {
            background: var(--macos-blue);
            color: white;
        }

        .badge-secondary {
            background: #8E8E93;
            color: white;
        }

        .badge-gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
        }

        .badge-success {
            background: #34C759;
            color: white;
        }

        .badge-danger {
            background: #FF3B30;
            color: white;
        }

        .badge-warning {
            background: #FF9500;
            color: white;
        }

        /* User Details Panel */
        .btn-secondary {
            background: var(--macos-bg-tertiary);
            color: var(--macos-text-primary);
        }

        .btn-secondary:hover {
            background: var(--macos-bg-hover);
        }

        #user-details-panel h3 {
            margin-bottom: 15px;
            color: var(--macos-text-primary);
        }

        .admin-table table tr th {
            width: 200px;
            text-align: left;
        }

        .admin-table table tr td {
            text-align: left;
        }

        /* Modal Styling (T035) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--macos-bg-primary);
            padding: 30px;
            border-radius: var(--macos-radius-medium);
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--macos-text-primary);
        }

        .modal-content p {
            margin-bottom: 20px;
            color: var(--macos-text-secondary);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--macos-border);
            border-radius: var(--macos-radius-medium);
            margin: 15px 0;
            font-size: 14px;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: var(--macos-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .action-buttons-grid button {
            width: 100%;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        code {
            background: var(--macos-bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
        }

        .status-active {
            color: #28a745;
            font-weight: 500;
        }

        .status-inactive {
            color: #dc3545;
            font-weight: 500;
        }

        details summary {
            cursor: pointer;
            user-select: none;
        }

        details[open] summary {
            margin-bottom: 10px;
        }

        pre {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
        }

        /* Breadcrumb Navigation (T042) */
        .breadcrumb {
            padding: 10px 30px;
            background: var(--macos-bg-secondary);
            border-bottom: 1px solid var(--macos-border);
            font-size: 14px;
            color: var(--macos-text-secondary);
            font-weight: 500;
        }

        /* Responsive Design (T044) */
        @media (max-width: 768px) {
            .admin-layout {
                flex-direction: column;
            }

            .admin-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--macos-border);
                padding: 15px;
            }

            .admin-nav {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 10px;
            }

            .admin-nav-link {
                text-align: center;
                flex-direction: column;
                padding: 10px;
            }

            .admin-nav-icon {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 20px;
            }

            .admin-content {
                padding: 20px 15px;
            }

            .breadcrumb {
                padding: 8px 15px;
                font-size: 13px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            /* Touch-friendly buttons */
            .btn, .admin-nav-link {
                min-height: 44px;
                min-width: 44px;
            }

            .user-search-row {
                cursor: pointer;
                -webkit-tap-highlight-color: rgba(0, 122, 255, 0.1);
            }

            /* Table horizontal scroll */
            .admin-table {
                overflow-x: auto;
            }

            .admin-table table {
                min-width: 600px;
            }
        }

        @media (max-width: 480px) {
            .admin-header-title {
                font-size: 22px;
            }

            .stat-value {
                font-size: 24px;
            }

            .admin-table table {
                font-size: 12px;
            }

            .btn {
                padding: 8px 15px;
                font-size: 13px;
            }
        }

        /* Dashboard Tabs Styling */
        .dashboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--macos-border);
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--macos-text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .tab-btn:hover {
            color: var(--macos-blue);
        }

        .tab-btn.active {
            color: var(--macos-blue);
            border-bottom-color: var(--macos-blue);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Message Form Styling */
        .admin-form {
            background: var(--macos-bg-secondary);
            padding: 30px;
            border-radius: var(--macos-radius-medium);
        }

        .form-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--macos-border);
        }

        .form-section:last-of-type {
            border-bottom: none;
        }

        .form-section h3 {
            color: var(--macos-text-primary);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--macos-text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--macos-border);
            border-radius: var(--macos-radius-medium);
            background: var(--macos-bg-primary);
            color: var(--macos-text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--macos-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }

        .form-radio-group, .form-checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }

        .form-radio-label, .form-checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: normal;
            color: var(--macos-text-primary);
        }

        .form-radio-label input[type="radio"],
        .form-checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            align-items: center;
        }

        .text-secondary {
            color: var(--macos-text-secondary);
        }

        .text-help {
            font-size: 12px;
            color: var(--macos-text-secondary);
            margin-top: 5px;
        }

        #targetPreview {
            background: var(--macos-bg-tertiary);
            padding: 15px;
            border-radius: var(--macos-radius-medium);
            border-left: 4px solid var(--macos-blue);
        }

        #userSearchResults {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--macos-border);
            border-radius: var(--macos-radius-medium);
            background: var(--macos-bg-primary);
        }

        .user-search-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--macos-border);
        }

        .user-search-item:hover {
            background: var(--macos-bg-hover);
        }

        #selectedUsers {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .selected-user-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--macos-blue);
            color: white;
            border-radius: 16px;
            font-size: 13px;
        }

        .selected-user-remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            line-height: 1;
        }

        /* ===================================================================
           MESSAGE PREVIEW STYLING
           Feature: 027-in-admin2-html
           ================================================================ */

        /* Preview button styling */
        .btn-preview {
            background-color: var(--macos-blue) !important;
            color: white !important;
        }

        .btn-preview:hover {
            opacity: 0.9;
        }

        /* Preview modal stacking */
        #admin-preview-modal-overlay {
            z-index: 10001 !important; /* Stack over edit modal (which is 10000) */
        }

        /* Subtle preview mode indicator */
        .message-modal.preview-mode {
            position: relative;
        }

        .message-modal.preview-mode::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 3px dashed rgba(var(--macos-blue-rgb), 0.3);
            border-radius: inherit;
            pointer-events: none;
            z-index: 1;
        }

        /* Feedback & Support Specific Styling */
        .feedback-row {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .feedback-row:hover {
            background-color: var(--macos-blue) !important;
            color: white;
        }

        .feedback-row:hover * {
            color: white !important;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .status-nieuw {
            background-color: #fecaca;
            color: #991b1b;
        }

        .status-bekeken {
            background-color: #bfdbfe;
            color: #1e40af;
        }

        .status-in_behandeling {
            background-color: #fed7aa;
            color: #9a3412;
        }

        .status-opgelost {
            background-color: #bbf7d0;
            color: #166534;
        }

        .feedback-detail {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .feedback-detail .detail-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .feedback-detail .detail-row label {
            color: var(--macos-text-secondary);
            font-size: 14px;
        }

        .feedback-detail .detail-content {
            background: var(--macos-gray-6);
            padding: 12px;
            border-radius: 6px;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--macos-text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background-color: var(--macos-gray-5);
            color: var(--macos-text-primary);
        }

        /* Feedback Modal Specific Sizing */
        #feedbackModal .modal-content {
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            width: 90%;
        }

        #feedbackModal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--macos-border);
        }

        #feedbackModal .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        #feedbackModal .modal-body {
            padding: 0;
        }

        /* Modal Footer Styling */
        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--macos-border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background-color: var(--macos-bg-secondary);
        }

        .btn-primary {
            padding: 10px 20px;
            background-color: var(--macos-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background-color: #0051a8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 102, 204, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 102, 204, 0.2);
        }
    </style>

    <!-- Chart.js for revenue charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <div class="admin-layout">
        <!-- Sidebar Navigation -->
        <nav class="admin-sidebar">
            <div class="admin-sidebar-header">
                <div class="admin-sidebar-title">Admin Dashboard</div>
                <div class="admin-sidebar-subtitle">Tickedify v2</div>
            </div>
            <ul class="admin-nav">
                <li class="admin-nav-item">
                    <a href="#home" class="admin-nav-link active" data-screen="home">
                        <span class="admin-nav-icon">üè†</span>
                        <span>Home</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#tasks" class="admin-nav-link" data-screen="tasks">
                        <span class="admin-nav-icon">üìä</span>
                        <span>Task Analytics</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#emails" class="admin-nav-link" data-screen="emails">
                        <span class="admin-nav-icon">üìß</span>
                        <span>Email Analytics</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#database" class="admin-nav-link" data-screen="database">
                        <span class="admin-nav-icon">üíæ</span>
                        <span>Database Monitor</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#revenue" class="admin-nav-link" data-screen="revenue">
                        <span class="admin-nav-icon">üí∞</span>
                        <span>Revenue Dashboard</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#users" class="admin-nav-link" data-screen="users">
                        <span class="admin-nav-icon">üë•</span>
                        <span>User Management</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#feedback" class="admin-nav-link" data-screen="feedback">
                        <span class="admin-nav-icon">üí¨</span>
                        <span>Feedback</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#system" class="admin-nav-link" data-screen="system">
                        <span class="admin-nav-icon">‚öôÔ∏è</span>
                        <span>System Settings</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#dbtools" class="admin-nav-link" data-screen="dbtools">
                        <span class="admin-nav-icon">üîß</span>
                        <span>Database Tools</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#debug" class="admin-nav-link" data-screen="debug">
                        <span class="admin-nav-icon">üîç</span>
                        <span>Debug Tools</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#security" class="admin-nav-link" data-screen="security">
                        <span class="admin-nav-icon">üîí</span>
                        <span>Security</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#backups" class="admin-nav-link" data-screen="backups">
                        <span class="admin-nav-icon">üíæ</span>
                        <span>Backups</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#messages" class="admin-nav-link" data-screen="messages">
                        <span class="admin-nav-icon">üì¢</span>
                        <span>Berichten</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#page-help" class="admin-nav-link" data-screen="page-help">
                        <span class="admin-nav-icon"><i class="fas fa-question-circle"></i></span>
                        <span>Page Help</span>
                    </a>
                </li>
                <li class="admin-nav-item">
                    <a href="#test-env" class="admin-nav-link" data-screen="test-env">
                        <span class="admin-nav-icon">üß™</span>
                        <span>Test Environment</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content Area with Breadcrumb -->
        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
            <!-- Breadcrumb Navigation (T042) -->
            <div class="breadcrumb" id="breadcrumb">
                <span id="breadcrumb-text">üè† Home Dashboard</span>
            </div>

            <main class="admin-content" style="flex: 1;">
            <!-- Home Dashboard Screen -->
            <section id="screen-home" class="admin-screen active" data-screen="home">
                <div class="admin-header">
                    <h1 class="admin-header-title">Home Dashboard</h1>
                    <p class="admin-header-subtitle">Overview of key metrics and system health</p>
                </div>
                <div id="home-content">
                    <!-- Stats Grid 1: User Metrics -->
                    <div class="stats-grid">
                        <div class="stat-card" id="total-users-card">
                            <div class="stat-label">üë• Total Users</div>
                            <div class="stat-value" id="total-users">--</div>
                            <div class="stat-subtext">All registered accounts</div>
                        </div>
                        <div class="stat-card" id="active-7d-card">
                            <div class="stat-label">‚ö° Active Users (7d)</div>
                            <div class="stat-value" id="active-7d">--</div>
                            <div class="stat-subtext">Active in last 7 days</div>
                        </div>
                        <div class="stat-card" id="active-30d-card">
                            <div class="stat-label">üìä Active Users (30d)</div>
                            <div class="stat-value" id="active-30d">--</div>
                            <div class="stat-subtext">Active in last 30 days</div>
                        </div>
                        <div class="stat-card" id="new-registrations-card">
                            <div class="stat-label">üìù New Registrations</div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                                <div>
                                    <div style="font-size: 20px; font-weight: 700; color: var(--macos-text-primary);" id="new-today">--</div>
                                    <div style="font-size: 11px; color: var(--macos-text-secondary);">Today</div>
                                </div>
                                <div>
                                    <div style="font-size: 20px; font-weight: 700; color: var(--macos-text-primary);" id="new-week">--</div>
                                    <div style="font-size: 11px; color: var(--macos-text-secondary);">Week</div>
                                </div>
                                <div>
                                    <div style="font-size: 20px; font-weight: 700; color: var(--macos-text-primary);" id="new-month">--</div>
                                    <div style="font-size: 11px; color: var(--macos-text-secondary);">Month</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Grid 2: Subscription Distribution -->
                    <div class="stats-grid">
                        <div class="stat-card" id="free-tier-card">
                            <div class="stat-label">üÜì Free Tier</div>
                            <div class="stat-value" id="free-tier">--</div>
                            <div class="stat-subtext">Free plan users</div>
                        </div>
                        <div class="stat-card" id="premium-tier-card">
                            <div class="stat-label">‚≠ê Premium Tier</div>
                            <div class="stat-value" id="premium-tier">--</div>
                            <div class="stat-subtext">Premium plan users</div>
                        </div>
                        <div class="stat-card" id="enterprise-tier-card">
                            <div class="stat-label">üíé Enterprise Tier</div>
                            <div class="stat-value" id="enterprise-tier">--</div>
                            <div class="stat-subtext">Enterprise plan users</div>
                        </div>
                        <div class="stat-card" id="active-trials-card">
                            <div class="stat-label">üéØ Active Trials</div>
                            <div class="stat-value" id="active-trials">--</div>
                            <div class="stat-subtext">Users in trial period</div>
                        </div>
                    </div>

                    <!-- User Growth Chart -->
                    <div class="chart-container">
                        <h3>User Growth (30 days)</h3>
                        <canvas id="userGrowthChart"></canvas>
                    </div>

                    <!-- Recent Registrations Table -->
                    <div class="admin-table">
                        <h3>Recent Registrations (Last 10)</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Naam</th>
                                    <th>Tier</th>
                                    <th>Created At</th>
                                </tr>
                            </thead>
                            <tbody id="recentRegistrationsTable">
                                <tr><td colspan="4" style="text-align:center; padding: 40px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Stats Grid 3: Inactive Users -->
                    <div class="stats-grid">
                        <div class="stat-card" id="inactive-30d-card">
                            <div class="stat-label">üí§ Inactive (30d)</div>
                            <div class="stat-value" id="inactive-30d">--</div>
                            <div class="stat-subtext">No activity in 30 days</div>
                        </div>
                        <div class="stat-card" id="inactive-60d-card">
                            <div class="stat-label">üò¥ Inactive (60d)</div>
                            <div class="stat-value" id="inactive-60d">--</div>
                            <div class="stat-subtext">No activity in 60 days</div>
                        </div>
                        <div class="stat-card" id="inactive-90d-card">
                            <div class="stat-label">‚è∞ Inactive (90d)</div>
                            <div class="stat-value" id="inactive-90d">--</div>
                            <div class="stat-subtext">No activity in 90 days</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Task Analytics Screen -->
            <section id="screen-tasks" class="admin-screen" data-screen="tasks">
                <div class="admin-header">
                    <h1 class="admin-header-title">Task Analytics</h1>
                    <p class="admin-header-subtitle">Task statistics and completion metrics</p>
                </div>
                <div id="tasks-content">
                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">üìã Total Tasks</div>
                            <div class="stat-value" id="tasks-total">--</div>
                            <div class="stat-subtext">All tasks in system</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">‚úÖ Completed</div>
                            <div class="stat-value" id="tasks-completed">--</div>
                            <div class="stat-subtext" id="tasks-completed-subtext">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">‚è≥ Pending</div>
                            <div class="stat-value" id="tasks-pending">--</div>
                            <div class="stat-subtext" id="tasks-pending-subtext">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">üìà Completion Rate</div>
                            <div class="stat-value" id="tasks-completion-rate">--</div>
                            <div class="stat-subtext">Overall completion</div>
                        </div>
                    </div>

                    <!-- Creation Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">üÜï Created Today</div>
                            <div class="stat-value" id="tasks-today">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">üìÖ Created This Week</div>
                            <div class="stat-value" id="tasks-week">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">üìÜ Created This Month</div>
                            <div class="stat-value" id="tasks-month">--</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Email Analytics Screen -->
            <section id="screen-emails" class="admin-screen" data-screen="emails">
                <div class="admin-header">
                    <h1 class="admin-header-title">Email Analytics</h1>
                    <p class="admin-header-subtitle">Email import statistics and user engagement</p>
                </div>
                <div id="emails-content"></div>
            </section>

            <!-- Database Monitor Screen -->
            <section id="screen-database" class="admin-screen" data-screen="database">
                <div class="admin-header">
                    <h1 class="admin-header-title">Database Monitor</h1>
                    <p class="admin-header-subtitle">Database size and table statistics</p>
                </div>
                <div id="database-content">
                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">üíæ Database Size</div>
                            <div class="stat-value" id="db-size">--</div>
                            <div class="stat-subtext">Total storage used</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">üìä Total Tables</div>
                            <div class="stat-value" id="db-tables">--</div>
                            <div class="stat-subtext">Database schema</div>
                        </div>
                    </div>

                    <!-- Tables Breakdown -->
                    <div class="admin-table">
                        <h3>Tables Breakdown</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Table Name</th>
                                    <th>Rows</th>
                                    <th>Size (MB)</th>
                                </tr>
                            </thead>
                            <tbody id="db-tables-list">
                                <tr><td colspan="3" style="text-align:center;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Revenue Dashboard Screen -->
            <section id="screen-revenue" class="admin-screen" data-screen="revenue">
                <div class="admin-header">
                    <h1 class="admin-header-title">Revenue Dashboard</h1>
                    <p class="admin-header-subtitle">Payment configurations and MRR tracking</p>
                </div>
                <div id="revenue-content">
                    <!-- MRR Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">üí∞ Monthly Recurring Revenue</div>
                            <div class="stat-value" id="revenue-mrr">--</div>
                            <div class="stat-subtext">Total MRR</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">üë• Active Subscriptions</div>
                            <div class="stat-value" id="revenue-active">--</div>
                            <div class="stat-subtext">Paying customers</div>
                        </div>
                    </div>

                    <!-- Revenue by Tier Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">üÜì Free Tier Revenue</div>
                            <div class="stat-value" id="revenue-free">‚Ç¨0</div>
                            <div class="stat-subtext">No revenue from free</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">‚≠ê Premium Revenue</div>
                            <div class="stat-value" id="revenue-premium">--</div>
                            <div class="stat-subtext" id="revenue-premium-subtext">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">üíé Enterprise Revenue</div>
                            <div class="stat-value" id="revenue-enterprise">--</div>
                            <div class="stat-subtext" id="revenue-enterprise-subtext">--</div>
                        </div>
                    </div>
                </div>

                <!-- Revenue Detail Modal -->
                <div id="revenue-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; max-width: 900px; max-height: 80vh; width: 90%; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <!-- Modal Header -->
                        <div style="padding: 20px 30px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <h2 id="revenue-modal-title" style="margin: 0; font-size: 20px; font-weight: 600;">Revenue Details</h2>
                            <button onclick="window.closeRevenueModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; padding: 0; width: 30px; height: 30px;">&times;</button>
                        </div>

                        <!-- Modal Body -->
                        <div id="revenue-modal-body" style="padding: 30px; overflow-y: auto; max-height: calc(80vh - 80px);">
                            <!-- Content will be injected here via JavaScript -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- User Management Screen -->
            <section id="screen-users" class="admin-screen" data-screen="users">
                <div class="admin-header">
                    <h1 class="admin-header-title">User Management</h1>
                    <p class="admin-header-subtitle">Search, view, and manage user accounts</p>
                </div>
                <div id="users-content">
                    <!-- Search results -->
                    <div id="user-search-results">
                        <!-- Search box en results worden hier geladen via JavaScript -->
                    </div>

                    <!-- User details panel (hidden by default) -->
                    <div id="user-details-panel" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>User Details</h3>
                            <button class="btn btn-secondary" onclick="Screens.closeUserDetails()">
                                ‚Üê Back to Search
                            </button>
                        </div>

                        <!-- User Info Grid -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">üìß Email</div>
                                <div class="stat-value" id="detail-email" style="font-size: 16px;">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">üë§ Naam</div>
                                <div class="stat-value" id="detail-naam" style="font-size: 16px;">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">üéØ Account Type</div>
                                <div class="stat-value" id="detail-account-type" style="font-size: 16px;">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">‚≠ê Subscription Tier</div>
                                <div class="stat-value" id="detail-tier" style="font-size: 16px;">--</div>
                            </div>
                        </div>

                        <!-- Task Summary -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">üìã Total Tasks</div>
                                <div class="stat-value" id="detail-tasks-total">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">‚úÖ Completed</div>
                                <div class="stat-value" id="detail-tasks-completed">--</div>
                                <div class="stat-subtext" id="detail-tasks-rate">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">‚è≥ Pending</div>
                                <div class="stat-value" id="detail-tasks-pending">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">üîÑ Recurring</div>
                                <div class="stat-value" id="detail-tasks-recurring">--</div>
                            </div>
                        </div>

                        <!-- Task Activity Chart (Feature 073) -->
                        <div class="task-activity-section" style="margin: 30px 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">üìä Task Activity</h3>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <select id="activity-period-selector" class="form-select" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--macos-border);">
                                        <option value="week" selected>This Week</option>
                                        <option value="month">This Month</option>
                                        <option value="quarter">This Quarter</option>
                                        <option value="year">This Year</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Custom Date Range (hidden by default) -->
                            <div id="custom-date-range" style="display: none; margin-bottom: 15px; padding: 15px; background: var(--macos-background); border-radius: 8px; border: 1px solid var(--macos-border);">
                                <div style="display: flex; gap: 15px; align-items: center;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-size: 12px; color: var(--macos-text-secondary);">Start Date</label>
                                        <input type="date" id="activity-start-date" class="form-input" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--macos-border);">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-size: 12px; color: var(--macos-text-secondary);">End Date</label>
                                        <input type="date" id="activity-end-date" class="form-input" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--macos-border);">
                                    </div>
                                    <button id="apply-custom-dates" class="btn btn-primary" style="align-self: flex-end;">Apply</button>
                                </div>
                                <div id="date-range-error" style="display: none; color: #dc3545; font-size: 12px; margin-top: 10px;"></div>
                            </div>

                            <!-- Chart Container -->
                            <div style="background: white; border-radius: 8px; padding: 20px; border: 1px solid var(--macos-border);">
                                <div id="activity-chart-loading" style="text-align: center; padding: 40px; color: var(--macos-text-secondary);">
                                    Loading chart...
                                </div>
                                <canvas id="task-activity-chart" style="display: none; max-height: 300px;"></canvas>
                            </div>

                            <!-- Activity Statistics -->
                            <div class="stats-grid" style="margin-top: 20px;">
                                <div class="stat-card">
                                    <div class="stat-label">üìà Total Tasks</div>
                                    <div class="stat-value" id="activity-stat-total">--</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">üìä Average/Day</div>
                                    <div class="stat-value" id="activity-stat-average">--</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">üèÜ Peak Day</div>
                                    <div class="stat-value" id="activity-stat-peak">--</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">üìâ Trend</div>
                                    <div class="stat-value" id="activity-stat-trend">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Email Summary -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">üìß Total Email Imports</div>
                                <div class="stat-value" id="detail-emails-total">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">üÜï Recent (30d)</div>
                                <div class="stat-value" id="detail-emails-recent">--</div>
                            </div>
                        </div>

                        <!-- Subscription Details -->
                        <div class="admin-table" style="margin-bottom: 30px;">
                            <h3>Subscription Details</h3>
                            <table>
                                <tr>
                                    <th>Status</th>
                                    <td id="detail-sub-status">--</td>
                                </tr>
                                <tr>
                                    <th>Trial End Date</th>
                                    <td id="detail-trial-end">--</td>
                                </tr>
                                <tr>
                                    <th>Created At</th>
                                    <td id="detail-created">--</td>
                                </tr>
                                <tr>
                                    <th>Last Login</th>
                                    <td id="detail-last-login">--</td>
                                </tr>
                            </table>
                        </div>

                        <!-- User Actions (T035) -->
                        <div id="user-actions" style="margin-top: 30px;">
                            <h3>User Actions</h3>

                            <div class="action-buttons-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                                <!-- Change Tier -->
                                <button class="btn btn-primary" onclick="UserActions.showChangeTierModal()">
                                    ‚≠ê Change Subscription Tier
                                </button>

                                <!-- Extend Trial -->
                                <button class="btn btn-primary" onclick="UserActions.showExtendTrialModal()">
                                    üéØ Extend Trial Date
                                </button>

                                <!-- Reset Password (T036) -->
                                <button class="btn btn-primary" onclick="UserActions.showResetPasswordModal()">
                                    üîë Reset Password
                                </button>

                                <!-- Block/Unblock -->
                                <button class="btn btn-danger" id="block-user-btn" onclick="UserActions.toggleBlockUser()">
                                    üîí Block User
                                </button>

                                <!-- Force Logout -->
                                <button class="btn btn-primary" onclick="UserActions.forceLogout()">
                                    üö™ Force Logout
                                </button>

                                <!-- Delete User (T036) -->
                                <button class="btn btn-danger" onclick="UserActions.showDeleteUserModal()">
                                    üóëÔ∏è Delete User Account
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- System Settings Screen -->
            <section id="screen-system" class="admin-screen" data-screen="system">
                <div class="admin-header">
                    <h1 class="admin-header-title">System Settings</h1>
                    <p class="admin-header-subtitle">Configure system-wide settings</p>
                </div>
                <div id="system-content">
                    <!-- System Settings Section -->
                    <div class="admin-table">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>‚öôÔ∏è System Settings</h3>
                            <button class="btn btn-primary" onclick="SystemActions.refreshSettings()">
                                üîÑ Refresh
                            </button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Setting Key</th>
                                    <th>Current Value</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="system-settings-table">
                                <tr><td colspan="4" style="text-align:center;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Payment Configurations Section -->
                    <div class="admin-table" style="margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>üí∞ Payment Configurations</h3>
                            <button class="btn btn-primary" onclick="SystemActions.refreshPayments()">
                                üîÑ Refresh
                            </button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Plan ID</th>
                                    <th>Plan Name</th>
                                    <th>Checkout URL</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="payment-configs-table">
                                <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Database Tools Screen -->
            <section id="screen-dbtools" class="admin-screen" data-screen="dbtools">
                <div class="admin-header">
                    <h1 class="admin-header-title">Database Tools</h1>
                    <p class="admin-header-subtitle">SQL queries, backups, and cleanup operations</p>
                </div>
                <div id="dbtools-content"></div>
            </section>

            <!-- Debug Tools Screen -->
            <section id="screen-debug" class="admin-screen" data-screen="debug">
                <div class="admin-header">
                    <h1 class="admin-header-title">Debug Tools</h1>
                    <p class="admin-header-subtitle">User data inspection and diagnostic tools</p>
                </div>
                <div id="debug-content">
                    <div class="admin-table">
                        <h3>üîç User Data Inspector</h3>
                        <p>Deep inspection of user data for debugging purposes. Shows complete data breakdown.</p>

                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <input
                                type="text"
                                id="debug-user-email"
                                placeholder="Enter email address..."
                                style="flex: 1; padding: 10px; border: 1px solid var(--macos-border); border-radius: 8px;"
                            />
                            <button class="btn btn-primary" onclick="DebugTools.inspectUser()">
                                üîç Inspect User
                            </button>
                        </div>

                        <div id="debug-user-results" style="display: none;">
                            <!-- Results will be displayed here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Security Screen -->
            <section id="screen-security" class="admin-screen" data-screen="security">
                <div class="admin-header">
                    <h1 class="admin-header-title">Security</h1>
                    <p class="admin-header-subtitle">Session management and security controls</p>
                </div>
                <div id="security-content">
                    <!-- Security Statistics -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">üîê Active Sessions</div>
                            <div class="stat-value" id="security-active-sessions">--</div>
                            <div class="stat-subtext">Currently logged in users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">üö´ Blocked Users</div>
                            <div class="stat-value" id="security-blocked-users">--</div>
                            <div class="stat-subtext">Accounts with actief=false</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">üë• Total Users</div>
                            <div class="stat-value" id="security-total-users">--</div>
                            <div class="stat-subtext">All registered accounts</div>
                        </div>
                    </div>

                    <!-- Recent Admin Actions -->
                    <div class="admin-table" style="margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>üìú Recent Admin Actions (Audit Log)</h3>
                            <button class="btn btn-primary" onclick="SecurityTools.refreshAuditLog()">
                                üîÑ Refresh
                            </button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Admin User</th>
                                    <th>Action</th>
                                    <th>Target</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="audit-log-table">
                                <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
                            </tbody>
                        </table>
                        <div style="margin-top: 10px; font-size: 12px; color: var(--macos-text-secondary);">
                            Showing last 50 admin actions
                        </div>
                    </div>

                    <!-- Session Management -->
                    <div class="admin-table" style="margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>üë§ Active Sessions</h3>
                            <button class="btn btn-primary" onclick="SecurityTools.refreshSessions()">
                                üîÑ Refresh
                            </button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>User Email</th>
                                    <th>Session Created</th>
                                    <th>Expires</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sessions-table">
                                <tr><td colspan="4" style="text-align:center;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Backups Screen -->
            <section id="screen-backups" class="admin-screen" data-screen="backups">
                <div class="admin-header">
                    <h1 class="admin-header-title">üíæ Backup Management</h1>
                    <p class="admin-header-subtitle">Database backups and transaction history</p>
                </div>

                <!-- Backup Stats Cards -->
                <div class="admin-stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-label">üì¶ Total Backups</div>
                        <div class="stat-value" id="backupTotal">--</div>
                        <div class="stat-sublabel">All stored backups</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üïê Last Backup</div>
                        <div class="stat-value" id="backupLastTime" style="font-size: 16px;">--</div>
                        <div class="stat-sublabel">Most recent backup time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">‚úÖ Status</div>
                        <div class="stat-value" id="backupStatus">--</div>
                        <div class="stat-sublabel">Last backup status</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üìù Transactions (3d)</div>
                        <div class="stat-value" id="transactionTotal">--</div>
                        <div class="stat-sublabel">Last 3 days of logs</div>
                    </div>
                </div>

                <!-- Create Backup Button -->
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" id="createBackupBtn" onclick="BackupManager.createBackup()" style="font-size: 14px;">
                        ‚ûï Create Manual Backup
                    </button>
                </div>

                <!-- Backups Table -->
                <div class="admin-table">
                    <h3 style="margin-bottom: 15px;">üì¶ Recent Backups</h3>
                    <div id="backupsTable">
                        <div style="color: #666;">Loading backups...</div>
                    </div>
                </div>

                <!-- Transaction Log -->
                <div class="admin-table" style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>üìú Transaction Log (Last 3 Days)</h3>
                        <div style="display: flex; gap: 10px;">
                            <select id="txLogTableFilter" onchange="BackupManager.loadTransactionLog()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px;">
                                <option value="">All Tables</option>
                                <option value="acties">acties</option>
                                <option value="daily_planning">daily_planning</option>
                                <option value="projecten">projecten</option>
                                <option value="users">users</option>
                            </select>
                            <select id="txLogOperationFilter" onchange="BackupManager.loadTransactionLog()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px;">
                                <option value="">All Operations</option>
                                <option value="INSERT">INSERT</option>
                                <option value="UPDATE">UPDATE</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                        </div>
                    </div>
                    <div id="transactionLogTable">
                        <div style="color: #666;">Loading transaction log...</div>
                    </div>
                </div>
            </section>

            <!-- Messages Screen -->
            <section id="screen-messages" class="admin-screen" data-screen="messages">
                <div class="admin-header">
                    <h1 class="admin-header-title">üì¢ In-App Berichten Systeem</h1>
                    <p class="admin-header-subtitle">Stuur gerichte berichten naar gebruikers</p>
                </div>

                <!-- Messages List -->
                <div class="admin-table">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>üìã Alle Berichten</h3>
                        <div>
                            <button class="btn btn-primary" onclick="openCreateMessageModal()" style="font-size: 14px; margin-right: 10px;">
                                ‚ûï Nieuw Bericht
                            </button>
                            <button class="btn btn-secondary" onclick="loadMessagesList()" style="font-size: 14px;">
                                üîÑ Ververs
                            </button>
                        </div>
                    </div>
                    <div id="messages-list-container">
                        <p class="text-secondary" style="text-align: center; padding: 40px;">
                            <span id="messages-loading">Laden...</span>
                            <span id="messages-empty" style="display: none;">Geen berichten gevonden</span>
                        </p>
                        <table id="messages-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Titel</th>
                                    <th>Target</th>
                                    <th>Trigger</th>
                                    <th>Aangemaakt</th>
                                    <th>Status</th>
                                    <th>Stats</th>
                                    <th>Acties</th>
                                </tr>
                            </thead>
                            <tbody id="messages-table-body">
                                <!-- Rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Page Help Screen -->
            <section id="screen-page-help" class="admin-screen" data-screen="page-help">
                <div class="admin-header">
                    <h1 class="admin-header-title"><i class="fas fa-question-circle"></i> Page Help Configuration</h1>
                    <p class="admin-header-subtitle">Manage help content for application pages</p>
                </div>

                <div style="max-width: 1200px;">
                    <!-- Page Selector -->
                    <div style="margin-bottom: 30px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--macos-text-primary);">
                            Select Page
                        </label>
                        <select id="page-help-selector" class="form-select" style="width: 100%; max-width: 400px; padding: 10px; font-size: 14px; border: 1px solid var(--macos-border); border-radius: var(--macos-radius-medium); background: white;">
                            <option value="">-- Choose a page --</option>
                            <option value="inbox">Inbox</option>
                            <option value="acties">Acties</option>
                            <option value="opvolgen">Opvolgen</option>
                            <option value="dagelijkse-planning">Dagelijkse Planning</option>
                            <option value="uitgesteld">Uitgesteld (Postponed)</option>
                            <option value="afgewerkt">Afgewerkt</option>
                            <option value="email-import">Email Import</option>
                            <option value="projecten">Projecten</option>
                            <option value="prullenbak">Prullenbak</option>
                            <option value="contextenbeheer">Contextenbeheer</option>
                        </select>
                    </div>

                    <!-- Content Editor Container (shown when page selected) -->
                    <div id="page-help-editor-container" style="display: none;">
                        <!-- Status Indicator -->
                        <div style="margin-bottom: 20px; padding: 12px; background: var(--macos-bg-secondary); border-radius: var(--macos-radius-medium); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>Content Status:</strong>
                                <span id="page-help-status-badge" class="badge-feature" style="margin-left: 8px;">Default</span>
                            </div>
                            <div style="font-size: 12px; color: var(--macos-text-secondary);" id="page-help-modified-info">
                                <!-- Modified date/user info will appear here -->
                            </div>
                        </div>

                        <!-- Editor Layout: Side-by-side Editor and Preview -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <!-- Left: Content Editor -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--macos-text-primary);">
                                    Help Content (Markdown)
                                </label>
                                <textarea
                                    id="page-help-content"
                                    style="width: 100%; height: 400px; padding: 12px; font-family: 'Monaco', 'Courier New', monospace; font-size: 13px; border: 1px solid var(--macos-border); border-radius: var(--macos-radius-medium); resize: vertical;"
                                    placeholder="Enter help content in Markdown format...

Examples:
# Main Heading
## Sub Heading

**Bold text** and *italic text*

- Bullet list item 1
- Bullet list item 2

1. Numbered list item 1
2. Numbered list item 2

[Link text](https://example.com)"
                                ></textarea>
                                <div style="margin-top: 8px; font-size: 12px; color: var(--macos-text-secondary);">
                                    Supports Markdown: headings, bold, italic, lists, links (no images)
                                </div>
                            </div>

                            <!-- Right: Live Preview -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--macos-text-primary);">
                                    Preview
                                </label>
                                <div
                                    id="page-help-preview"
                                    style="width: 100%; height: 400px; padding: 12px; border: 1px solid var(--macos-border); border-radius: var(--macos-radius-medium); background: white; overflow-y: auto;"
                                >
                                    <p style="color: var(--macos-text-secondary); font-style: italic;">Preview will appear here...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="savePageHelpContent()" id="page-help-save-btn">
                                üíæ Save Content
                            </button>
                            <button class="btn btn-secondary" onclick="revertToDefault()" id="page-help-revert-btn" style="display: none;">
                                ‚Ü©Ô∏è Revert to Default
                            </button>
                            <button class="btn btn-secondary" onclick="refreshPageHelpEditor()" style="margin-left: auto;">
                                üîÑ Refresh
                            </button>
                        </div>

                        <!-- Help Text -->
                        <div style="padding: 15px; background: #e8f4fd; border-left: 4px solid var(--macos-blue); border-radius: var(--macos-radius-medium); font-size: 13px;">
                            <strong>üí° Tips:</strong>
                            <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                                <li>Keep content concise and helpful (200-500 words recommended)</li>
                                <li>Use headings to organize sections clearly</li>
                                <li>Preview updates in real-time as you type</li>
                                <li>Save custom content or revert to default at any time</li>
                                <li>All content must be in English (per UI policy)</li>
                            </ul>
                        </div>
                    </div>

                    <!-- No Page Selected State -->
                    <div id="page-help-no-selection" style="text-align: center; padding: 60px 20px; color: var(--macos-text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚ùì</div>
                        <h3 style="margin: 0 0 8px 0; color: var(--macos-text-primary);">No Page Selected</h3>
                        <p style="margin: 0;">Select a page from the dropdown above to view and edit its help content.</p>
                    </div>
                </div>
            </section>

            <!-- Test Environment Screen -->
            <section id="screen-test-env" class="admin-screen" data-screen="test-env">
                <div class="admin-header">
                    <h1 class="admin-header-title">üß™ Test Environment</h1>
                    <p class="admin-header-subtitle">Manage test database with production data isolation</p>
                </div>

                <div style="max-width: 1400px;">
                    <!-- Database Status Cards -->
                    <div class="stats-grid" style="margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-label">Production Database</div>
                            <div class="stat-value" id="prod-db-status">--</div>
                            <div class="stat-subtitle" id="prod-db-latency">Checking...</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Test Database</div>
                            <div class="stat-value" id="test-db-status">--</div>
                            <div class="stat-subtitle" id="test-db-latency">Checking...</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Environment</div>
                            <div class="stat-value" id="current-env">--</div>
                            <div class="stat-subtitle">Current deployment</div>
                        </div>
                    </div>

                    <!-- Database Operations Section -->
                    <div style="margin-bottom: 30px; padding: 20px; background: var(--macos-bg-secondary); border-radius: var(--macos-radius-large);">
                        <h2 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;">Database Operations</h2>

                        <div style="display: grid; gap: 15px;">
                            <!-- Copy Schema Button -->
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: white; border-radius: var(--macos-radius-medium); border: 1px solid var(--macos-border);">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px;">üìã Copy Schema to Test DB</div>
                                    <div style="font-size: 12px; color: var(--macos-text-secondary);">Copy production database structure (tables, constraints, indexes) to test database</div>
                                </div>
                                <button class="btn btn-primary" onclick="copySchemaToTest()" id="copy-schema-btn">
                                    Copy Schema
                                </button>
                            </div>

                            <!-- Validate Schema Button -->
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: white; border-radius: var(--macos-radius-medium); border: 1px solid var(--macos-border);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">üîç Validate Schema Sync</div>
                                    <div style="font-size: 12px; color: var(--macos-text-secondary);">Compare production and test database structures before copying users</div>
                                    <div id="schema-validation-result" style="margin-top: 8px; font-size: 12px; display: none;"></div>
                                </div>
                                <button class="btn btn-secondary" onclick="validateSchema()" id="validate-schema-btn">
                                    Validate
                                </button>
                            </div>

                            <!-- Clear Test Database Button -->
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: white; border-radius: var(--macos-radius-medium); border: 1px solid var(--macos-border);">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px;">üóëÔ∏è Clear Test Database</div>
                                    <div style="font-size: 12px; color: var(--macos-text-secondary);">Delete all data from test database (preserves schema)</div>
                                </div>
                                <button class="btn btn-danger" onclick="clearTestDatabase()" id="clear-db-btn">
                                    Clear Data
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- User Management Section -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Production Users List -->
                        <div style="padding: 20px; background: var(--macos-bg-secondary); border-radius: var(--macos-radius-large);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h2 style="margin: 0; font-size: 18px; font-weight: 600;">üë• Production Users</h2>
                                <button class="btn btn-secondary" onclick="loadProductionUsers()" id="refresh-prod-users-btn">
                                    üîÑ Refresh
                                </button>
                            </div>

                            <div id="production-users-list" style="background: white; border-radius: var(--macos-radius-medium); border: 1px solid var(--macos-border); max-height: 400px; overflow-y: auto;">
                                <div style="padding: 30px; text-align: center; color: var(--macos-text-secondary);">
                                    <div style="font-size: 32px; margin-bottom: 10px;">üë§</div>
                                    <div>Loading users...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Test Users List -->
                        <div style="padding: 20px; background: var(--macos-bg-secondary); border-radius: var(--macos-radius-large);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h2 style="margin: 0; font-size: 18px; font-weight: 600;">üß™ Test Database Users</h2>
                                <button class="btn btn-secondary" onclick="loadTestUsers()" id="refresh-test-users-btn">
                                    üîÑ Refresh
                                </button>
                            </div>

                            <div id="test-users-list" style="background: white; border-radius: var(--macos-radius-medium); border: 1px solid var(--macos-border); max-height: 400px; overflow-y: auto;">
                                <div style="padding: 30px; text-align: center; color: var(--macos-text-secondary);">
                                    <div style="font-size: 32px; margin-bottom: 10px;">üß™</div>
                                    <div>Loading test users...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Help Text -->
                    <div style="margin-top: 30px; padding: 15px; background: #e8f4fd; border-left: 4px solid var(--macos-blue); border-radius: var(--macos-radius-medium); font-size: 13px;">
                        <strong>üí° Usage Guide:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                            <li><strong>Copy Schema:</strong> Creates database structure in test DB (required before copying users)</li>
                            <li><strong>Copy User:</strong> Click "Copy to Test" next to a production user to copy all their data</li>
                            <li><strong>Delete User:</strong> Click "Delete" next to a test user to remove them from test DB</li>
                            <li><strong>Clear Database:</strong> Removes all data from test DB while preserving schema</li>
                            <li><strong>Environment:</strong> Test DB is only accessible on dev.tickedify.com (preview environment)</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Feedback Screen -->
            <section id="screen-feedback" class="admin-screen" data-screen="feedback">
                <div class="admin-header">
                    <h1 class="admin-header-title">üí¨ Feedback & Support</h1>
                    <p class="admin-header-subtitle">Beheer gebruikersfeedback en feature requests</p>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Totaal</div>
                        <div class="stat-value" id="feedbackTotal">-</div>
                        <div class="stat-subtitle">Alle feedback items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Nieuw</div>
                        <div class="stat-value" id="feedbackNieuw">-</div>
                        <div class="stat-subtitle">Nieuwe meldingen</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Bugs</div>
                        <div class="stat-value" id="feedbackBugs">-</div>
                        <div class="stat-subtitle">Bug reports</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Features</div>
                        <div class="stat-value" id="feedbackFeatures">-</div>
                        <div class="stat-subtitle">Feature requests</div>
                    </div>
                </div>

                <!-- Feedback Table -->
                <div class="admin-table">
                    <h3 style="margin-bottom: 15px;">üìã Alle Feedback</h3>
                    <div id="feedbackTable">
                        <div class="loading">Laden...</div>
                    </div>
                </div>
            </section>
        </main>
        </div><!-- Close breadcrumb wrapper -->
    </div><!-- Close admin-layout -->

    <!-- Change Tier Modal (T035) -->
    <div id="change-tier-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Change Subscription Tier</h3>
            <p>Select new tier for <strong id="tier-user-email">--</strong></p>

            <select id="tier-select" class="form-select">
                <option value="free">Free</option>
                <option value="premium">Premium</option>
                <option value="enterprise">Enterprise</option>
            </select>

            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="UserActions.changeTier()">Change Tier</button>
                <button class="btn btn-secondary" onclick="UserActions.closeModal('change-tier-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Extend Trial Modal (T035) -->
    <div id="extend-trial-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Extend Trial Date</h3>
            <p>Set new trial end date for <strong id="trial-user-email">--</strong></p>

            <input type="date" id="trial-date-input" class="form-input" />

            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="UserActions.extendTrial()">Extend Trial</button>
                <button class="btn btn-secondary" onclick="UserActions.closeModal('extend-trial-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Delete User Modal (T036) -->
    <div id="delete-user-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 style="color: #FF3B30;">‚ö†Ô∏è Delete User Account</h3>
            <p>Are you absolutely sure you want to delete <strong id="delete-user-email">--</strong>?</p>

            <div style="background: #FEE; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <strong>Warning:</strong> This action cannot be undone.
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>All tasks will be deleted</li>
                    <li>All email imports will be deleted</li>
                    <li>All sessions will be invalidated</li>
                    <li>User will be immediately logged out</li>
                </ul>
            </div>

            <label style="display: block; margin: 15px 0;">
                <input type="checkbox" id="delete-confirm-checkbox" />
                I understand this action is permanent
            </label>

            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="UserActions.deleteUser()" id="delete-confirm-btn" disabled>
                    Delete Account
                </button>
                <button class="btn btn-secondary" onclick="UserActions.closeModal('delete-user-modal')">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal (T036) -->
    <div id="reset-password-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>üîë Reset User Password</h3>
            <p>Generate new password for <strong id="reset-user-email">--</strong></p>

            <div style="background: #FFF8E1; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <strong>Note:</strong> A random 12-character password will be generated.
                You must securely provide it to the user.
            </div>

            <!-- New password display (hidden initially) -->
            <div id="new-password-display" style="display: none; background: #E8F5E9; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <strong>New Password:</strong>
                <div style="font-family: monospace; font-size: 18px; padding: 10px; background: white; border-radius: 4px; margin-top: 10px;">
                    <span id="new-password-value">--</span>
                    <button onclick="UserActions.copyPassword()" style="margin-left: 10px; padding: 5px 10px; border: none; background: var(--macos-blue); color: white; border-radius: 4px; cursor: pointer;">
                        üìã Copy
                    </button>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="UserActions.resetPassword()" id="reset-password-btn">
                    Generate New Password
                </button>
                <button class="btn btn-secondary" onclick="UserActions.closeModal('reset-password-modal')">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Setting Modal -->
    <div id="edit-setting-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Edit System Setting</h3>
            <p><strong>Key:</strong> <span id="edit-setting-key">--</span></p>
            <p><strong>Description:</strong> <span id="edit-setting-description">--</span></p>

            <label>New Value:</label>
            <input type="text" id="edit-setting-value" class="form-input" placeholder="Enter new value" />

            <div id="setting-value-help" style="font-size: 12px; color: var(--macos-text-secondary); margin-top: 5px;">
                <!-- Dynamic help text based on setting type -->
            </div>

            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="SystemActions.updateSetting()">Save Changes</button>
                <button class="btn btn-secondary" onclick="SystemActions.closeModal('edit-setting-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Checkout URL Modal -->
    <div id="edit-checkout-url-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Edit Checkout URL</h3>
            <p><strong>Plan:</strong> <span id="edit-plan-name">--</span></p>

            <label>Checkout URL:</label>
            <input type="url" id="edit-checkout-url" class="form-input" placeholder="https://pay.mollie.com/..." />

            <div style="font-size: 12px; color: var(--macos-text-secondary); margin-top: 5px;">
                Must be a valid HTTPS URL from a trusted payment provider (Mollie, Stripe, PayPal, Paddle)
            </div>

            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="SystemActions.updateCheckoutURL()">Update URL</button>
                <button class="btn btn-secondary" onclick="SystemActions.closeModal('edit-checkout-url-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Message Create/Edit Modal -->
    <div id="message-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <h3 id="message-modal-title">üì¢ Nieuw Bericht</h3>

            <form id="message-creation-form" class="admin-form">
                <input type="hidden" id="message-edit-id" value="">

                <!-- Basic Info -->
                <div class="form-section">
                    <h3>Bericht Content</h3>
                    <div class="form-group">
                        <label class="form-label">Titel *</label>
                        <input type="text" class="form-input" id="msg-title" maxlength="255" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bericht *</label>
                        <textarea class="form-textarea" id="msg-message" maxlength="10000" required></textarea>
                        <div class="text-help">Markdown ondersteund. <a href="https://www.markdownguide.org/cheat-sheet/" target="_blank" rel="noopener noreferrer" style="color: var(--macos-blue); text-decoration: none;">Cheat sheet ‚Üí</a></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type *</label>
                        <select class="form-input" id="msg-type" required>
                            <option value="information">‚ÑπÔ∏è Information - Algemene informatie (blauw)</option>
                            <option value="educational">üìö Educational - Educatieve tip (blauw)</option>
                            <option value="feature">üÜï Feature - Nieuwe functionaliteit (groen)</option>
                            <option value="tip">üí° Tip - Handige tip (geel)</option>
                            <option value="warning">‚ö†Ô∏è Warning - Waarschuwing (oranje)</option>
                            <option value="important">‚ùó Important - Belangrijk bericht (rood)</option>
                        </select>
                        <div class="text-help">Bepaalt het icoon en de kleur van het bericht</div>
                    </div>
                </div>

                <!-- Targeting Section -->
                <div class="form-section">
                    <h3>Doelgroep</h3>
                    <div class="form-group">
                        <label class="form-label">Selecteer doelgroep *</label>
                        <div class="form-radio-group">
                            <label class="form-radio-label">
                                <input type="radio" name="targetType" value="all" checked>
                                <span>üåç Alle gebruikers</span>
                            </label>
                            <label class="form-radio-label">
                                <input type="radio" name="targetType" value="filtered">
                                <span>üéØ Gefilterd op abonnement</span>
                            </label>
                            <label class="form-radio-label">
                                <input type="radio" name="targetType" value="specific_users">
                                <span>üë§ Specifieke gebruikers</span>
                            </label>
                        </div>
                    </div>

                    <!-- Subscription Filter (hidden by default) -->
                    <div id="subscriptionFilterSection" class="form-group" style="display: none; margin-left: 30px;">
                        <label class="form-label">Abonnementen selecteren:</label>
                        <div class="form-checkbox-group">
                            <label class="form-checkbox-label">
                                <input type="checkbox" name="subscription" value="free">
                                <span>Free</span>
                            </label>
                            <label class="form-checkbox-label">
                                <input type="checkbox" name="subscription" value="premium">
                                <span>Premium</span>
                            </label>
                            <label class="form-checkbox-label">
                                <input type="checkbox" name="subscription" value="trial">
                                <span>Trial</span>
                            </label>
                        </div>
                    </div>

                    <!-- User Search (hidden by default) -->
                    <div id="userSearchSection" class="form-group" style="display: none; margin-left: 30px;">
                        <label class="form-label" for="userSearchInput">Zoek gebruikers (min 2 tekens):</label>
                        <input type="text" class="form-input" id="userSearchInput" placeholder="Naam of email...">
                        <div id="userSearchResults"></div>
                        <div id="selectedUsers"></div>
                    </div>

                    <!-- Target Preview -->
                    <div id="targetPreview" class="form-group" style="display: none; margin-top: 20px;">
                        <label class="form-label">üìä Doelgroep preview:</label>
                        <div id="targetPreviewContent"></div>
                    </div>
                </div>

                <!-- Trigger Section -->
                <div class="form-section">
                    <h3>Trigger</h3>
                    <div class="form-group">
                        <label class="form-label">Wanneer tonen? *</label>
                        <div class="form-radio-group">
                            <label class="form-radio-label">
                                <input type="radio" name="triggerType" value="immediate" checked>
                                <span>‚ö° Direct (bij eerstvolgende page load)</span>
                            </label>
                            <label class="form-radio-label">
                                <input type="radio" name="triggerType" value="next_page_visit">
                                <span>üìç Volgend bezoek aan pagina</span>
                            </label>
                            <label class="form-radio-label">
                                <input type="radio" name="triggerType" value="days_after_signup">
                                <span>üìÖ X dagen na signup</span>
                            </label>
                            <label class="form-radio-label">
                                <input type="radio" name="triggerType" value="first_page_visit">
                                <span>üëÅÔ∏è Eerste bezoek aan pagina</span>
                            </label>
                            <label class="form-radio-label">
                                <input type="radio" name="triggerType" value="nth_page_visit">
                                <span>üî¢ Na N bezoeken aan pagina</span>
                            </label>
                        </div>
                    </div>

                    <!-- Days After Signup Input (hidden by default) -->
                    <div id="daysAfterSignupSection" class="form-group" style="display: none; margin-left: 30px;">
                        <label class="form-label" for="daysAfterSignup">Aantal dagen:</label>
                        <input type="number" class="form-input" id="daysAfterSignup" min="1" max="365" placeholder="3">
                    </div>

                    <!-- First Page Visit Select (hidden by default) -->
                    <div id="firstPageVisitSection" class="form-group" style="display: none; margin-left: 30px;">
                        <label class="form-label" for="firstPageSelect">Selecteer pagina:</label>
                        <select class="form-input" id="firstPageSelect">
                            <option value="dagelijkse-planning">Dagelijkse Planning</option>
                            <option value="actielijst">Actielijst</option>
                            <option value="inbox">Inbox</option>
                            <option value="edit-task-modal">Taak Bewerken Modal</option>
                            <option value="quick-add-modal">Quick Add Modal</option>
                            <option value="recurring-task-popup">Herhalende Taak Popup</option>
                            <option value="planning-popup">Planning Popup</option>
                        </select>
                    </div>

                    <!-- Nth Page Visit Inputs (hidden by default) -->
                    <div id="nthPageVisitSection" class="form-group" style="display: none; margin-left: 30px;">
                        <label class="form-label" for="nthVisitCount">Na bezoek nummer:</label>
                        <input type="number" class="form-input" id="nthVisitCount" min="1" max="100" placeholder="5">
                        <label class="form-label" for="nthPageSelect" style="margin-top: 10px;">Aan pagina:</label>
                        <select class="form-input" id="nthPageSelect">
                            <option value="dagelijkse-planning">Dagelijkse Planning</option>
                            <option value="actielijst">Actielijst</option>
                            <option value="inbox">Inbox</option>
                            <option value="edit-task-modal">Taak Bewerken Modal</option>
                            <option value="quick-add-modal">Quick Add Modal</option>
                            <option value="recurring-task-popup">Herhalende Taak Popup</option>
                            <option value="planning-popup">Planning Popup</option>
                        </select>
                    </div>

                    <!-- Next Page Visit Select (hidden by default) -->
                    <div id="nextPageVisitSection" class="form-group" style="display: none; margin-left: 30px;">
                        <label class="form-label" for="nextPageSelect">Selecteer pagina:</label>
                        <select class="form-input" id="nextPageSelect">
                            <option value="">-- Kies een pagina --</option>

                            <!-- Lijsten -->
                            <optgroup label="Lijsten">
                                <option value="/inbox">Inbox</option>
                                <option value="/actielijst">Actielijst</option>
                                <option value="/projecten">Projecten</option>
                                <option value="/follow-up">Follow-up</option>
                                <option value="/completed">Afgewerkte Taken</option>
                                <option value="/planning">Dagelijkse Planning</option>
                                <option value="/postponed">Uitgesteld</option>
                            </optgroup>

                            <!-- Tools -->
                            <optgroup label="Tools">
                                <option value="/contextenbeheer">Contextenbeheer</option>
                                <option value="/wekelijkse-optimalisatie">Wekelijkse Optimalisatie</option>
                                <option value="/zoeken">Zoeken</option>
                            </optgroup>

                            <!-- Popups -->
                            <optgroup label="Popups">
                                <option value="/planning-popup">Planning Popup</option>
                                <option value="/recurring-popup">Recurring Popup</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <!-- Scheduling Section -->
                <div class="form-section">
                    <h3>Planning (Optioneel)</h3>
                    <div class="form-group">
                        <label class="form-label" for="publishAt">Publiceren op:</label>
                        <input type="datetime-local" class="form-input" id="publishAt" onchange="updatePublishWarning()">
                        <div class="text-help">Leeg laten voor direct publiceren</div>
                        <div id="future-publish-warning" style="display: none; margin-top: 8px; padding: 10px; background: #D1ECF1; border-left: 4px solid #17A2B8; border-radius: 4px; color: #0C5460;">
                            üìÖ <strong>Info:</strong> Bericht wordt pas zichtbaar vanaf <span id="publish-date-display"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="expiresAt">Verloopt op:</label>
                        <input type="datetime-local" class="form-input" id="expiresAt">
                        <div class="text-help">Leeg laten voor geen vervaldatum</div>
                    </div>
                </div>

                <!-- Active Status -->
                <div class="form-section">
                    <div class="form-group">
                        <label class="form-checkbox-label">
                            <input type="checkbox" id="msg-active" checked onchange="updateActiveWarning()">
                            <span>‚úÖ Bericht actief maken</span>
                        </label>
                        <div class="text-help">Inactieve berichten worden niet getoond aan gebruikers</div>
                        <div id="inactive-warning" style="display: none; margin-top: 8px; padding: 10px; background: #FFF3CD; border-left: 4px solid #FFC107; border-radius: 4px; color: #856404;">
                            ‚ö†Ô∏è <strong>Let op:</strong> Bericht is niet actief - gebruikers zullen dit niet zien
                        </div>
                    </div>
                </div>

                <!-- Submit -->
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="previewMessageFromForm()" style="margin-right: 10px;">
                        üëÅÔ∏è Preview
                    </button>
                    <button type="submit" class="btn btn-primary" id="message-modal-submit">üì¢ Bericht Aanmaken</button>
                    <button type="button" class="btn btn-secondary" onclick="closeMessageModal()">Annuleren</button>
                </div>
                <div id="message-status"></div>
            </form>
        </div>
    </div>

    <!-- Authentication Check -->
    <script>
        // Check admin authentication before loading dashboard
        (async function() {
            try {
                const response = await fetch('/api/admin/session');
                const data = await response.json();

                if (!data.authenticated || !data.isAdmin) {
                    // Not authenticated - redirect to login
                    window.location.href = '/admin2/login';
                }
                // If authenticated, continue loading the page
            } catch (error) {
                // Error checking session - redirect to login for safety
                console.error('Session check failed:', error);
                window.location.href = '/admin2/login';
            }
        })();
    </script>
    <script src="admin2.js"></script>

    <!-- Messaging System JavaScript -->
    <script>
        // ============================================================================
        // TOAST NOTIFICATION SYSTEM
        // ============================================================================

        class ToastManager {
            constructor() {
                this.container = document.getElementById('toast-container');
                this.toasts = [];
            }

            show(message, type = 'info', duration = 4000) {
                const toast = this.createToast(message, type);
                this.container.appendChild(toast);
                this.toasts.push(toast);

                // Auto dismiss (unless duration is 0)
                if (duration > 0) {
                    const timeoutId = setTimeout(() => {
                        this.dismiss(toast);
                    }, duration);

                    // Click to dismiss
                    toast.addEventListener('click', () => {
                        clearTimeout(timeoutId);
                        this.dismiss(toast);
                    });
                }

                return toast;
            }

            createToast(message, type) {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;

                toast.innerHTML = `
                    <div class="toast-icon"></div>
                    <div class="toast-message">${message}</div>
                `;

                return toast;
            }

            dismiss(toast) {
                toast.classList.add('toast-exit');

                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                    const index = this.toasts.indexOf(toast);
                    if (index > -1) {
                        this.toasts.splice(index, 1);
                    }
                }, 300); // Match animation duration
            }

            success(message, duration = 4000) {
                return this.show(message, 'success', duration);
            }

            error(message, duration = 6000) {
                return this.show(message, 'error', duration);
            }

            info(message, duration = 4000) {
                return this.show(message, 'info', duration);
            }

            warning(message, duration = 5000) {
                return this.show(message, 'warning', duration);
            }
        }

        // Global toast instance
        const toast = new ToastManager();

        // Wrapper function for compatibility with existing code
        function showToast(message, type = 'info', duration = 4000) {
            return toast.show(message, type, duration);
        }

        // ============================================================================
        // MESSAGING SYSTEM - PHASE 2
        // ============================================================================

        // State voor user selection en debouncing
        let selectedUserIds = [];
        let selectedUsersData = {}; // Map userId -> {naam, email}
        let searchDebounceTimer = null;
        let previewDebounceTimer = null;

        // Cache voor messages (gebruikt door preview functie)
        let messagesCache = [];

        // Helper: Convert UTC timestamp to local ISO string for datetime-local input
        // This fixes the timezone bug where times displayed 2 hours earlier when editing messages
        // datetime-local expects local time string (e.g., "2025-10-24T10:00")
        // but toISOString() returns UTC string (e.g., "2025-10-24T08:00:00.000Z")
        function toLocalISOString(utcTimestamp) {
            if (!utcTimestamp) return '';
            const date = new Date(utcTimestamp);
            // Adjust for timezone offset: subtract offset to get local time
            const localDate = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
            return localDate.toISOString().slice(0, 16);
        }

        // Initialize messaging form event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Target type radio buttons
            const targetTypeRadios = document.querySelectorAll('input[name="targetType"]');
            targetTypeRadios.forEach(radio => {
                radio.addEventListener('change', handleTargetTypeChange);
            });

            // Trigger type radio buttons
            const triggerTypeRadios = document.querySelectorAll('input[name="triggerType"]');
            triggerTypeRadios.forEach(radio => {
                radio.addEventListener('change', handleTriggerTypeChange);
            });

            // User search input
            const userSearchInput = document.getElementById('userSearchInput');
            if (userSearchInput) {
                userSearchInput.addEventListener('input', handleUserSearch);
            }

            // Subscription checkboxes
            const subscriptionCheckboxes = document.querySelectorAll('input[name="subscription"]');
            subscriptionCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateTargetPreview);
            });

            // Message form submit
            const messageForm = document.getElementById('message-creation-form');
            if (messageForm) {
                messageForm.addEventListener('submit', handleMessageSubmit);
            }

            // Load messages lijst wanneer #messages scherm actief is
            const checkMessagesScreen = () => {
                if (window.location.hash === '#messages') {
                    loadMessagesList();
                }
            };

            // Check bij page load
            checkMessagesScreen();

            // Check bij hash change
            window.addEventListener('hashchange', checkMessagesScreen);
        });

        // Handle target type change
        function handleTargetTypeChange(e) {
            const targetType = e.target.value;
            const subscriptionSection = document.getElementById('subscriptionFilterSection');
            const userSearchSection = document.getElementById('userSearchSection');

            // Reset visibility
            subscriptionSection.style.display = 'none';
            userSearchSection.style.display = 'none';

            if (targetType === 'filtered') {
                subscriptionSection.style.display = 'block';
            } else if (targetType === 'specific_users') {
                userSearchSection.style.display = 'block';
            }

            updateTargetPreview();
        }

        // Handle trigger type change
        function handleTriggerTypeChange(e) {
            const triggerType = e.target.value;
            const daysSection = document.getElementById('daysAfterSignupSection');
            const firstPageSection = document.getElementById('firstPageVisitSection');
            const nthPageSection = document.getElementById('nthPageVisitSection');
            const nextPageSection = document.getElementById('nextPageVisitSection');

            // Reset visibility
            daysSection.style.display = 'none';
            firstPageSection.style.display = 'none';
            nthPageSection.style.display = 'none';
            nextPageSection.style.display = 'none';

            // Reset required attributes
            document.getElementById('nextPageSelect').required = false;

            if (triggerType === 'days_after_signup') {
                daysSection.style.display = 'block';
            } else if (triggerType === 'first_page_visit') {
                firstPageSection.style.display = 'block';
            } else if (triggerType === 'nth_page_visit') {
                nthPageSection.style.display = 'block';
            } else if (triggerType === 'next_page_visit') {
                nextPageSection.style.display = 'block';
                document.getElementById('nextPageSelect').required = true;
            }
        }

        // Handle user search with debouncing
        function handleUserSearch(e) {
            const query = e.target.value.trim();

            clearTimeout(searchDebounceTimer);

            if (query.length < 2) {
                document.getElementById('userSearchResults').innerHTML = '';
                return;
            }

            searchDebounceTimer = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/admin2/users/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    const resultsDiv = document.getElementById('userSearchResults');
                    if (data.results && data.results.length > 0) {
                        resultsDiv.innerHTML = data.results
                            .filter(u => !selectedUserIds.includes(u.id))
                            .map(u => `
                                <div class="user-search-item"
                                     onclick="selectUser('${u.id}', '${escapeJsString(u.naam || 'Unnamed')}', '${escapeJsString(u.email)}')">
                                    <div>
                                        <strong>${escapeHtml(u.naam || 'Unnamed')}</strong>
                                        <div style="font-size: 12px; color: var(--macos-text-secondary);">${escapeHtml(u.email)}</div>
                                    </div>
                                </div>
                            `).join('');
                    } else {
                        resultsDiv.innerHTML = '<div style="padding: 8px; color: var(--macos-text-secondary);">Geen gebruikers gevonden</div>';
                    }
                } catch (error) {
                    console.error('User search error:', error);
                }
            }, 500);
        }

        // Escape HTML helper
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Escape JavaScript string helper
        function escapeJsString(text) {
            if (!text) return '';
            return text
                .replace(/\\/g, '\\\\')   // Backslash must be first
                .replace(/'/g, "\\'")     // Single quote
                .replace(/"/g, '\\"')     // Double quote
                .replace(/\n/g, '\\n')    // Newline
                .replace(/\r/g, '\\r')    // Carriage return
                .replace(/\t/g, '\\t')    // Tab
                .replace(/\u2028/g, '\\u2028')  // Line separator
                .replace(/\u2029/g, '\\u2029'); // Paragraph separator
        }

        // Select user
        function selectUser(userId, userName, userEmail) {
            if (selectedUserIds.includes(userId)) return;

            selectedUserIds.push(userId);
            selectedUsersData[userId] = { naam: userName, email: userEmail };
            updateSelectedUsersDisplay();
            updateTargetPreview();

            // Clear search results
            document.getElementById('userSearchInput').value = '';
            document.getElementById('userSearchResults').innerHTML = '';
        }

        // Remove user
        function removeUser(userId) {
            selectedUserIds = selectedUserIds.filter(id => id !== userId);
            delete selectedUsersData[userId];
            updateSelectedUsersDisplay();
            updateTargetPreview();
        }

        // Update selected users display
        function updateSelectedUsersDisplay() {
            const selectedDiv = document.getElementById('selectedUsers');
            if (selectedUserIds.length === 0) {
                selectedDiv.innerHTML = '<div style="color: var(--macos-text-secondary); font-size: 14px; margin-top: 10px;">Geen gebruikers geselecteerd</div>';
                return;
            }

            selectedDiv.innerHTML = `
                <div style="margin-top: 10px; margin-bottom: 8px; font-weight: 600; color: var(--macos-text-primary);">
                    Geselecteerde gebruikers (${selectedUserIds.length}):
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${selectedUserIds.map(id => {
                        const userData = selectedUsersData[id] || {};
                        const displayName = userData.naam || 'Unnamed';
                        const displayEmail = userData.email || id;
                        return `
                            <div class="selected-user-badge">
                                <span><strong>${escapeHtml(displayName)}</strong> (${escapeHtml(displayEmail)})</span>
                                <span class="selected-user-remove" onclick="removeUser('${id}')">√ó</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Update target preview with debouncing
        function updateTargetPreview() {
            clearTimeout(previewDebounceTimer);

            previewDebounceTimer = setTimeout(async () => {
                try {
                    const targetType = document.querySelector('input[name="targetType"]:checked').value;
                    let targetSubscription = null;
                    let targetUsers = null;

                    if (targetType === 'filtered') {
                        const checkedSubs = Array.from(document.querySelectorAll('input[name="subscription"]:checked'))
                            .map(cb => cb.value);
                        if (checkedSubs.length === 0) {
                            document.getElementById('targetPreview').style.display = 'none';
                            return;
                        }
                        targetSubscription = JSON.stringify(checkedSubs);
                    } else if (targetType === 'specific_users') {
                        if (selectedUserIds.length === 0) {
                            document.getElementById('targetPreview').style.display = 'none';
                            return;
                        }
                        targetUsers = JSON.stringify(selectedUserIds);
                    }

                    const params = new URLSearchParams({ target_type: targetType });
                    if (targetSubscription) params.append('target_subscription', targetSubscription);
                    if (targetUsers) params.append('target_users', targetUsers);

                    const response = await fetch(`/api/admin/messages/preview-targets?${params}`);
                    const data = await response.json();

                    const previewDiv = document.getElementById('targetPreview');
                    const contentDiv = document.getElementById('targetPreviewContent');

                    // BUG FIX 034-als-ik-in: Handle undefined count for specific_users
                    let count = data.count;
                    let sample = data.sample || [];

                    // Fallback for specific_users: use selectedUserIds.length
                    if (targetType === 'specific_users' && (count === undefined || count === null)) {
                        count = selectedUserIds.length;
                        // Generate sample from selectedUsersData
                        sample = selectedUserIds.slice(0, 5).map(userId => ({
                            name: selectedUsersData[userId]?.naam,
                            email: selectedUsersData[userId]?.email
                        }));
                    }

                    // Ensure count is always a number
                    count = parseInt(count) || 0;

                    previewDiv.style.display = 'block';
                    contentDiv.innerHTML = `
                        <div style="font-size: 16px; font-weight: 600; color: var(--macos-blue); margin-bottom: 8px;">
                            ${count} gebruiker${count !== 1 ? 's' : ''} ${count === 1 ? 'zal' : 'zullen'} dit bericht ontvangen
                        </div>
                        ${sample && sample.length > 0 ? `
                            <div style="font-size: 14px; color: var(--macos-text-secondary); margin-top: 8px;">
                                Voorbeelden: ${sample.map(u => escapeHtml(u.name || u.email)).join(', ')}
                            </div>
                        ` : ''}
                    `;
                } catch (error) {
                    console.error('Preview error:', error);
                    // BUG FIX 034-als-ik-in: Show error state instead of leaving undefined
                    const previewDiv = document.getElementById('targetPreview');
                    const contentDiv = document.getElementById('targetPreviewContent');

                    previewDiv.style.display = 'block';
                    contentDiv.innerHTML = `
                        <div style="font-size: 14px; color: var(--macos-text-secondary);">
                            Preview kon niet worden geladen. Controleer de doelgroep instellingen.
                        </div>
                    `;
                }
            }, 500);
        }

        // Get trigger value based on trigger type
        function getTriggerValue() {
            const triggerType = document.querySelector('input[name="triggerType"]:checked').value;

            if (triggerType === 'immediate') {
                return null;
            } else if (triggerType === 'days_after_signup') {
                const days = document.getElementById('daysAfterSignup').value;
                return days ? days.toString() : null;
            } else if (triggerType === 'first_page_visit') {
                return document.getElementById('firstPageSelect').value;
            } else if (triggerType === 'nth_page_visit') {
                const count = document.getElementById('nthVisitCount').value;
                const page = document.getElementById('nthPageSelect').value;
                return count && page ? `${count}:${page}` : null;
            } else if (triggerType === 'next_page_visit') {
                return document.getElementById('nextPageSelect').value;
            }
            return null;
        }

        // Handle message form submit
        // ========================================
        // MESSAGE MODAL FUNCTIONS
        // ========================================

        // Open modal for creating new message
        function openCreateMessageModal() {
            resetMessageForm();
            document.getElementById('message-edit-id').value = '';
            document.getElementById('message-modal-title').textContent = 'üì¢ Nieuw Bericht';
            document.getElementById('message-modal-submit').textContent = 'üì¢ Bericht Aanmaken';
            document.getElementById('message-modal').style.display = 'flex';
        }

        // Open modal for editing existing message
        async function openEditMessageModal(messageId) {
            try {
                // Fetch message data
                const response = await fetch(`/api/admin/messages/${messageId}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch message');
                }

                const data = await response.json();
                const msg = data.message;

                // Set modal title and button
                document.getElementById('message-modal-title').textContent = '‚úèÔ∏è Bericht Bewerken';
                document.getElementById('message-modal-submit').textContent = 'üíæ Bericht Opslaan';
                document.getElementById('message-edit-id').value = messageId;

                // Fill basic fields
                document.getElementById('msg-title').value = msg.title || '';
                document.getElementById('msg-message').value = msg.message || '';
                document.getElementById('msg-type').value = msg.message_type || 'information';
                document.getElementById('msg-active').checked = msg.active !== false;

                // Set target type
                const targetType = msg.target_type || 'all';
                document.querySelector(`input[name="targetType"][value="${targetType}"]`).checked = true;
                handleTargetTypeChange({ target: { value: targetType } });

                // Set subscriptions if filtered
                if (targetType === 'filtered' && msg.target_subscription) {
                    const subs = Array.isArray(msg.target_subscription) ? msg.target_subscription : JSON.parse(msg.target_subscription || '[]');
                    subs.forEach(sub => {
                        const checkbox = document.querySelector(`input[name="subscription"][value="${sub}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                // Load specific users if target type is specific_users (BUG FIX: 034-als-ik-in)
                if (targetType === 'specific_users') {
                    if (msg.target_users && msg.target_users.length > 0) {
                        // Parse target_users (kan JSON string of array zijn)
                        const userIds = Array.isArray(msg.target_users)
                            ? msg.target_users
                            : JSON.parse(msg.target_users || '[]');

                        // Populate selectedUserIds state
                        selectedUserIds = userIds;

                        // Fetch real user data for each user ID
                        selectedUsersData = {};

                        // Fetch user details for each ID
                        const userDataPromises = userIds.map(async (userId) => {
                            try {
                                const response = await fetch(`/api/admin2/users/${userId}`, {
                                    credentials: 'include'
                                });

                                if (response.ok) {
                                    const data = await response.json();
                                    return {
                                        userId: userId,
                                        naam: data.user?.naam || `Gebruiker #${userId}`,
                                        email: data.user?.email || 'Onbekend'
                                    };
                                } else {
                                    // Fallback if user not found
                                    return {
                                        userId: userId,
                                        naam: `Gebruiker #${userId}`,
                                        email: 'Niet gevonden'
                                    };
                                }
                            } catch (error) {
                                console.error(`Error fetching user ${userId}:`, error);
                                return {
                                    userId: userId,
                                    naam: `Gebruiker #${userId}`,
                                    email: 'Fout bij laden'
                                };
                            }
                        });

                        // Wait for all user data to load
                        const usersData = await Promise.all(userDataPromises);

                        // Populate selectedUsersData
                        usersData.forEach(userData => {
                            selectedUsersData[userData.userId] = {
                                naam: userData.naam,
                                email: userData.email
                            };
                        });

                        // Render user badges in UI with real data
                        updateSelectedUsersDisplay();
                    } else {
                        // Edge case: Empty or null target_users
                        selectedUserIds = [];
                        selectedUsersData = {};
                        updateSelectedUsersDisplay(); // Shows "Geen gebruikers geselecteerd"
                    }
                }

                // Set trigger type
                const triggerType = msg.trigger_type || 'immediate';
                document.querySelector(`input[name="triggerType"][value="${triggerType}"]`).checked = true;
                handleTriggerTypeChange({ target: { value: triggerType } });

                // Set trigger value based on trigger type (BUG FIX: 034-als-ik-in)
                if (triggerType === 'days_after_signup') {
                    document.getElementById('daysAfterSignup').value = msg.trigger_value || '';
                } else if (triggerType === 'first_page_visit') {
                    const select = document.getElementById('firstPageSelect');
                    select.value = msg.trigger_value || '';
                    // Fallback: if value not in options, add it dynamically
                    if (select.value === '' && msg.trigger_value) {
                        const option = document.createElement('option');
                        option.value = msg.trigger_value;
                        option.textContent = msg.trigger_value + ' (custom)';
                        select.appendChild(option);
                        select.value = msg.trigger_value;
                    }
                } else if (triggerType === 'nth_page_visit') {
                    const parts = (msg.trigger_value || '').split(':');
                    if (parts.length === 2) {
                        document.getElementById('nthVisitCount').value = parts[0];
                        const select = document.getElementById('nthPageSelect');
                        select.value = parts[1];
                        // Fallback: if value not in options, add it dynamically
                        if (select.value === '' && parts[1]) {
                            const option = document.createElement('option');
                            option.value = parts[1];
                            option.textContent = parts[1] + ' (custom)';
                            select.appendChild(option);
                            select.value = parts[1];
                        }
                    }
                } else if (triggerType === 'next_page_visit') {
                    // BUG FIX: next_page_visit was NOT being loaded!
                    const select = document.getElementById('nextPageSelect');
                    select.value = msg.trigger_value || '';
                    // Fallback: if value not in options, add it dynamically
                    if (select.value === '' && msg.trigger_value) {
                        const option = document.createElement('option');
                        option.value = msg.trigger_value;
                        option.textContent = msg.trigger_value + ' (custom)';
                        select.appendChild(option);
                        select.value = msg.trigger_value;
                    }
                }

                // Set scheduling
                if (msg.publish_at) {
                    document.getElementById('publishAt').value = toLocalISOString(msg.publish_at);
                }
                if (msg.expires_at) {
                    document.getElementById('expiresAt').value = toLocalISOString(msg.expires_at);
                }

                // Open modal
                document.getElementById('message-modal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading message:', error);
                alert('Fout bij laden bericht: ' + error.message);
            }
        }

        // Close message modal
        function closeMessageModal() {
            document.getElementById('message-modal').style.display = 'none';
            resetMessageForm();
        }

        // Handle message submit (both create and update)
        async function handleMessageSubmit(e) {
            e.preventDefault();

            const statusDiv = document.getElementById('message-status');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const messageId = document.getElementById('message-edit-id').value;
            const isEdit = messageId !== '';

            try {
                submitBtn.disabled = true;
                statusDiv.style.display = 'block';
                statusDiv.style.background = 'var(--macos-blue)';
                statusDiv.style.color = 'white';
                statusDiv.style.padding = '10px';
                statusDiv.style.borderRadius = 'var(--macos-radius-medium)';
                statusDiv.textContent = isEdit ? '‚è≥ Bericht opslaan...' : '‚è≥ Bericht aanmaken...';

                // Collect form data
                const targetType = document.querySelector('input[name="targetType"]:checked').value;
                const triggerType = document.querySelector('input[name="triggerType"]:checked').value;

                let targetSubscription = null;
                let targetUsers = null;

                if (targetType === 'filtered') {
                    const checkedSubs = Array.from(document.querySelectorAll('input[name="subscription"]:checked'))
                        .map(cb => cb.value);
                    targetSubscription = checkedSubs.length > 0 ? checkedSubs : null;
                } else if (targetType === 'specific_users') {
                    targetUsers = selectedUserIds.length > 0 ? selectedUserIds : null;
                }

                const triggerValue = getTriggerValue();

                const publishAt = document.getElementById('publishAt').value;
                const expiresAt = document.getElementById('expiresAt').value;

                const messageData = {
                    title: document.getElementById('msg-title').value,
                    message: document.getElementById('msg-message').value,
                    message_type: document.getElementById('msg-type').value,
                    target_type: targetType,
                    target_subscription: targetSubscription,
                    target_users: targetUsers,
                    trigger_type: triggerType,
                    trigger_value: triggerValue,
                    dismissible: true,
                    snoozable: true,
                    publish_at: publishAt ? new Date(publishAt).toISOString() : null,
                    expires_at: expiresAt ? new Date(expiresAt).toISOString() : null,
                    button_label: null,
                    button_action: null,
                    button_target: null,
                    active: document.getElementById('msg-active').checked
                };

                const url = isEdit ? `/api/admin/messages/${messageId}` : '/api/admin/messages';
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(messageData)
                });

                const result = await response.json();

                if (response.ok) {
                    statusDiv.style.background = '#34C759';
                    statusDiv.textContent = isEdit
                        ? '‚úÖ Bericht succesvol bijgewerkt!'
                        : `‚úÖ Bericht succesvol aangemaakt! (ID: ${result.messageId})`;

                    // Reload list and close modal after 1 second
                    setTimeout(() => {
                        closeMessageModal();
                        loadMessagesList();
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Failed to save message');
                }
            } catch (error) {
                console.error('Message submit error:', error);
                statusDiv.style.background = '#FF3B30';
                statusDiv.textContent = `‚ùå Fout: ${error.message}`;
            } finally {
                submitBtn.disabled = false;
            }
        }

        // Update active warning
        function updateActiveWarning() {
            const activeCheckbox = document.getElementById('msg-active');
            const warningDiv = document.getElementById('inactive-warning');
            warningDiv.style.display = activeCheckbox.checked ? 'none' : 'block';
        }

        // Update publish date warning
        function updatePublishWarning() {
            const publishInput = document.getElementById('publishAt');
            const warningDiv = document.getElementById('future-publish-warning');
            const dateDisplay = document.getElementById('publish-date-display');

            if (!publishInput.value) {
                warningDiv.style.display = 'none';
                return;
            }

            const publishDate = new Date(publishInput.value);
            const now = new Date();

            if (publishDate > now) {
                const options = {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                dateDisplay.textContent = publishDate.toLocaleDateString('nl-NL', options);
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }
        }

        // Reset message form
        function resetMessageForm() {
            document.getElementById('message-creation-form').reset();
            selectedUserIds = [];
            selectedUsersData = {};
            updateSelectedUsersDisplay();
            document.getElementById('message-status').style.display = 'none';
            document.getElementById('targetPreview').style.display = 'none';
            document.getElementById('subscriptionFilterSection').style.display = 'none';
            document.getElementById('userSearchSection').style.display = 'none';
            document.getElementById('daysAfterSignupSection').style.display = 'none';
            document.getElementById('firstPageVisitSection').style.display = 'none';
            document.getElementById('nthPageVisitSection').style.display = 'none';
            document.getElementById('nextPageVisitSection').style.display = 'none';
            document.getElementById('inactive-warning').style.display = 'none';
            document.getElementById('future-publish-warning').style.display = 'none';
        }

        // ========================================
        // MESSAGE LIST FUNCTIONALITY
        // ========================================

        // Load messages list from API
        async function loadMessagesList() {
            const loadingEl = document.getElementById('messages-loading');
            const emptyEl = document.getElementById('messages-empty');
            const tableEl = document.getElementById('messages-table');

            // Show loading state
            loadingEl.style.display = 'inline';
            emptyEl.style.display = 'none';
            tableEl.style.display = 'none';

            try {
                const response = await fetch('/api/admin/messages', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch messages');
                }

                const data = await response.json();
                renderMessagesList(data.messages);
            } catch (error) {
                console.error('Load messages error:', error);
                loadingEl.innerHTML = '<span style="color: var(--macos-red);">‚ùå Fout bij laden berichten</span>';
            }
        }

        // Render messages table
        function renderMessagesList(messages) {
            const loadingEl = document.getElementById('messages-loading');
            const emptyEl = document.getElementById('messages-empty');
            const tableEl = document.getElementById('messages-table');
            const tbody = document.getElementById('messages-table-body');

            // Hide loading
            loadingEl.style.display = 'none';

            // Check if empty
            if (!messages || messages.length === 0) {
                emptyEl.style.display = 'inline';
                tableEl.style.display = 'none';
                messagesCache = []; // Clear cache
                return;
            }

            // Store messages in cache for preview functionality
            messagesCache = messages;

            // Show table
            emptyEl.style.display = 'none';
            tableEl.style.display = 'table';

            // Build rows
            tbody.innerHTML = messages.map(msg => {
                const typeBadge = getTypeBadge(msg.message_type);
                const targetText = getTargetText(msg);
                const triggerText = getTriggerText(msg);
                const dateText = formatMessageDate(msg.created_at);
                const isActive = msg.active;

                return `
                    <tr>
                        <td>${typeBadge}</td>
                        <td>
                            <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(msg.title)}</div>
                            <div style="font-size: 13px; color: var(--macos-text-secondary); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${escapeHtml(msg.message.substring(0, 80))}${msg.message.length > 80 ? '...' : ''}
                            </div>
                        </td>
                        <td style="font-size: 13px;">${targetText}</td>
                        <td style="font-size: 13px;">${triggerText}</td>
                        <td style="font-size: 13px; white-space: nowrap;">${dateText}</td>
                        <td>
                            <label class="toggle-switch" style="margin: 0;">
                                <input type="checkbox" ${isActive ? 'checked' : ''}
                                       onchange="toggleMessageActive(${msg.id}, ${isActive})">
                                <span class="toggle-slider"></span>
                            </label>
                        </td>
                        <td style="font-size: 13px;">
                            <div>üëÅÔ∏è ${msg.shown_count || 0}</div>
                            <div style="color: var(--macos-text-secondary);">‚úì ${msg.dismissed_count || 0}</div>
                        </td>
                        <td style="white-space: nowrap;">
                            <button class="btn btn-sm" onclick="openEditMessageModal(${msg.id})"
                                    title="Bericht bewerken"
                                    style="padding: 6px 10px; font-size: 12px; margin-right: 5px;">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-sm" onclick="duplicateMessage(${msg.id})"
                                    title="Bericht dupliceren"
                                    style="padding: 6px 10px; font-size: 12px; margin-right: 5px;">
                                üìã
                            </button>
                            <button class="btn btn-sm btn-preview" onclick="previewMessageFromList(${msg.id})"
                                    title="Preview bericht"
                                    style="padding: 6px 10px; font-size: 12px; margin-right: 5px; background-color: var(--macos-blue); color: white;">
                                üëÅÔ∏è
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteMessage(${msg.id}, '${escapeHtml(msg.title).replace(/'/g, "\\'")}')"
                                    title="Bericht verwijderen"
                                    style="padding: 6px 10px; font-size: 12px; background-color: #dc2626;">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get type badge HTML
        function getTypeBadge(type) {
            const badges = {
                information: { icon: '‚ÑπÔ∏è', label: 'Information', color: '#3b82f6' },
                educational: { icon: 'üìö', label: 'Educational', color: '#8b5cf6' },
                feature: { icon: 'üöÄ', label: 'Feature', color: '#10b981' },
                tip: { icon: 'üí°', label: 'Tip', color: '#f59e0b' },
                warning: { icon: '‚ö†Ô∏è', label: 'Warning', color: '#f97316' },
                important: { icon: '‚ùó', label: 'Important', color: '#ef4444' }
            };

            const badge = badges[type] || badges.information;
            return `<span style="display: inline-block; padding: 4px 10px; border-radius: 6px;
                    background: ${badge.color}20; color: ${badge.color};
                    font-size: 12px; font-weight: 600; white-space: nowrap;">
                ${badge.icon} ${badge.label}
            </span>`;
        }

        // Get target text
        function getTargetText(msg) {
            if (msg.target_type === 'all') return 'üë• Alle gebruikers';
            if (msg.target_type === 'filtered') {
                const subs = msg.target_subscriptions || [];
                return `üéØ Filtered (${subs.join(', ')})`;
            }
            if (msg.target_type === 'specific_users') {
                const userIds = msg.target_user_ids || [];
                return `üë§ ${userIds.length} user(s)`;
            }
            return 'Unknown';
        }

        // Get trigger text
        function getTriggerText(msg) {
            if (msg.trigger_type === 'immediate') return '‚ö° Direct';
            if (msg.trigger_type === 'days_after_signup') return `üìÖ ${msg.trigger_value} dagen na signup`;
            if (msg.trigger_type === 'first_page_visit') return `üîó Eerste bezoek: ${msg.trigger_page}`;
            if (msg.trigger_type === 'nth_page_visit') return `üîÅ ${msg.trigger_value}e bezoek: ${msg.trigger_page}`;
            return 'Unknown';
        }

        // Format date
        function formatMessageDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Vandaag';
            if (diffDays === 1) return 'Gisteren';
            if (diffDays < 7) return `${diffDays} dagen geleden`;

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Toggle message active status
        async function toggleMessageActive(messageId, currentActive) {
            try {
                const response = await fetch(`/api/admin/messages/${messageId}/toggle`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to toggle message');
                }

                const data = await response.json();
                console.log(`Message ${messageId} toggled:`, data.active);

                // Optionally show toast notification
                // showToast(data.active ? 'Bericht geactiveerd' : 'Bericht gedeactiveerd', 'success');
            } catch (error) {
                console.error('Toggle message error:', error);
                alert('Fout bij wijzigen status. Probeer opnieuw.');
                // Reload list to reset toggle state
                loadMessagesList();
            }
        }

        // Delete message with confirmation
        async function deleteMessage(messageId, messageTitle) {
            const confirmed = confirm(`Weet je zeker dat je dit bericht wilt verwijderen?\n\n"${messageTitle}"\n\nDeze actie kan niet ongedaan worden gemaakt.`);

            if (!confirmed) return;

            try {
                const response = await fetch(`/api/admin/messages/${messageId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete message');
                }

                const data = await response.json();
                console.log(`Message ${messageId} deleted:`, data);

                // Reload list
                loadMessagesList();
            } catch (error) {
                console.error('Delete message error:', error);
                alert('Fout bij verwijderen bericht. Probeer opnieuw.');
            }
        }

        // Duplicate message
        async function duplicateMessage(messageId) {
            try {
                const response = await fetch(`/api/admin/messages/${messageId}/duplicate`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to duplicate message');
                }

                const data = await response.json();
                console.log(`Message ${messageId} duplicated:`, data);

                // Reload list
                loadMessagesList();

                // Optionally show toast or alert
                alert(`Bericht gedupliceerd! Nieuwe ID: ${data.messageId}\n\nHet gedupliceerde bericht is inactief. Activeer het via de toggle schakelaar.`);
            } catch (error) {
                console.error('Duplicate message error:', error);
                alert('Fout bij dupliceren bericht. Probeer opnieuw.');
            }
        }

        // View message analytics
        function viewMessageAnalytics(messageId) {
            // TODO: Implement analytics modal/page in future
            alert(`Analytics voor bericht ${messageId} komt in een toekomstige versie`);
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===================================================================
        // MESSAGE PREVIEW FUNCTIONALITY
        // Feature: 027-in-admin2-html
        // ===================================================================

        /**
         * Show preview modal with message data
         * @param {Object} messageData - Message object to preview
         */
        function showPreview(messageData) {
            const modal = document.getElementById('admin-preview-modal-overlay');
            if (!modal) {
                console.error('Preview modal not found');
                return;
            }

            // Update icon based on message type
            const iconElement = modal.querySelector('.message-icon');
            if (iconElement && typeof getMessageIcon === 'function') {
                const iconClass = getMessageIcon(messageData.message_type || 'information');
                iconElement.className = `message-icon fas ${iconClass}`;
            }

            // Update content
            const titleElement = modal.querySelector('.message-title');
            const contentElement = modal.querySelector('.message-body .message-content');

            if (titleElement) titleElement.textContent = messageData.title || 'No Title';
            if (contentElement && typeof parseMarkdownLinks === 'function') {
                contentElement.innerHTML = messageData.message
                    ? parseMarkdownLinks(messageData.message)
                    : '<p style="color: var(--macos-text-secondary); font-style: italic;">No content</p>';
            }

            // Apply type-specific styling to modal (adds color header)
            const modalElement = modal.querySelector('.message-modal');
            if (modalElement) {
                modalElement.className = `message-modal message-${messageData.message_type || 'information'} preview-mode`;
            }

            // Handle action button
            const buttonContainer = modal.querySelector('.message-button');
            if (messageData.button_label && buttonContainer) {
                buttonContainer.innerHTML = `
                    <button class="btn-message-action" disabled
                            title="Preview mode - button disabled"
                            style="opacity: 0.6; cursor: not-allowed;">
                        ${messageData.button_label}
                    </button>
                `;
                buttonContainer.style.display = 'block';
            } else if (buttonContainer) {
                buttonContainer.style.display = 'none';
            }

            // Handle snooze options
            const snoozeContainer = modal.querySelector('.snooze-options');
            if (messageData.snoozable && snoozeContainer) {
                snoozeContainer.style.display = 'flex';
                snoozeContainer.querySelectorAll('button').forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                    btn.title = 'Preview mode - snooze disabled';
                });
            } else if (snoozeContainer) {
                snoozeContainer.style.display = 'none';
            }

            // Update dismiss button text - keep it functional to close preview
            const dismissBtn = modal.querySelector('.btn-message-dismiss');
            if (dismissBtn) {
                dismissBtn.textContent = 'Close Preview';
                dismissBtn.disabled = false;
                dismissBtn.title = 'Sluit preview';
                dismissBtn.style.opacity = '1';
                dismissBtn.style.cursor = 'pointer';
            }

            // Show modal
            modal.style.display = 'flex';
            console.log('üëÅÔ∏è Preview opened:', messageData.title);
        }

        /**
         * Preview message from list view
         * @param {number} messageId - ID of message to preview
         */
        function previewMessageFromList(messageId) {
            const message = messagesCache.find(m => m.id === messageId);

            if (!message) {
                console.error('Message not found in cache:', messageId);
                console.log('Available messages:', messagesCache.map(m => m.id));
                return;
            }

            showPreview(message);
        }

        /**
         * Preview message from form fields (edit modal)
         */
        function previewMessageFromForm() {
            // Helper function to convert empty strings to null
            const emptyToNull = (value) => (value && value.trim() !== '') ? value : null;

            const messageData = {
                title: document.getElementById('msg-title')?.value || 'No Title',
                message: document.getElementById('msg-message')?.value || '',
                message_type: document.getElementById('msg-type')?.value || 'information',
                // Convert empty strings to null to match cached message structure
                button_label: emptyToNull(document.getElementById('msg-button-label')?.value),
                button_action: emptyToNull(document.getElementById('msg-button-action')?.value),
                button_target: emptyToNull(document.getElementById('msg-button-target')?.value),
                dismissible: document.getElementById('msg-dismissible')?.checked ?? true,
                snoozable: document.getElementById('msg-snoozable')?.checked ?? false
            };

            showPreview(messageData);
        }

        /**
         * Close preview modal
         */
        function closePreview() {
            const modal = document.getElementById('admin-preview-modal-overlay');
            if (modal) modal.style.display = 'none';
        }
    </script>

    <!-- Message Preview Modal (matches structure from index.html) -->
    <div id="admin-preview-modal-overlay" class="modal-overlay" style="display: none; z-index: 10001;">
        <div class="message-modal preview-mode">
            <div class="message-header">
                <button class="btn-close-modal" onclick="closePreview()" aria-label="Sluit preview">
                    <i class="fas fa-times"></i>
                </button>
                <i class="message-icon fas fa-info-circle"></i>
                <h3 class="message-title">Message Title</h3>
                <span class="carousel-indicator preview-indicator" style="display: block; background: var(--macos-blue); color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;">üëÅÔ∏è PREVIEW</span>
            </div>
            <div class="message-body">
                <div class="message-content">Message content here</div>
            </div>

            <!-- Optional action button -->
            <div class="message-button" style="display: none;"></div>

            <div class="message-actions">
                <!-- Snooze options -->
                <div class="snooze-options" style="display: none;">
                    <button class="btn-snooze" data-duration="3600" disabled>Snooze 1h</button>
                    <button class="btn-snooze" data-duration="14400" disabled>Snooze 4h</button>
                    <button class="btn-snooze" data-duration="86400" disabled>Snooze 1d</button>
                </div>

                <!-- Dismiss -->
                <button class="btn-message-dismiss" onclick="closePreview()">Dismiss</button>
            </div>

            <!-- Carousel navigation -->
            <div class="message-navigation">
                <button class="btn-prev" style="display: none;" disabled>‚óÄ Previous</button>
                <button class="btn-next" style="display: none;" disabled>Next ‚ñ∂</button>
            </div>
        </div>
    </div>

    <!-- Feedback Detail Modal -->
    <div id="feedbackModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="feedbackModalTitle">Feedback Details</h2>
                <button onclick="closeFeedbackModal()" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="feedback-detail">
                    <div class="detail-row">
                        <label><strong>Type:</strong></label>
                        <span id="feedbackType"></span>
                    </div>
                    <div class="detail-row">
                        <label><strong>Gebruiker:</strong></label>
                        <span id="feedbackUser"></span>
                    </div>
                    <div class="detail-row">
                        <label><strong>Datum:</strong></label>
                        <span id="feedbackDate"></span>
                    </div>
                    <div class="detail-row">
                        <label><strong>Status:</strong></label>
                        <select id="feedbackStatus" onchange="updateFeedbackStatus()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--macos-border); font-size: 14px;">
                            <option value="nieuw">üÜï Nieuw</option>
                            <option value="bekeken">üëÅÔ∏è Bekeken</option>
                            <option value="in_behandeling">üîÑ In behandeling</option>
                            <option value="opgelost">‚úÖ Opgelost</option>
                        </select>
                    </div>
                    <div class="detail-row">
                        <label><strong>Titel:</strong></label>
                        <div id="feedbackTitel" class="detail-content"></div>
                    </div>
                    <div class="detail-row">
                        <label><strong>Beschrijving:</strong></label>
                        <div id="feedbackBeschrijving" class="detail-content"></div>
                    </div>
                    <div class="detail-row" id="feedbackStappenRow" style="display: none;">
                        <label><strong>Stappen om te reproduceren:</strong></label>
                        <div id="feedbackStappen" class="detail-content"></div>
                    </div>
                    <div class="detail-row">
                        <label><strong>Context:</strong></label>
                        <div id="feedbackContext" class="detail-content"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="emailFeedbackUser()" class="btn-primary">
                    üìß Email Gebruiker
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // TEST ENVIRONMENT MANAGEMENT - Feature 064
        // ============================================================================

        // Initialize test environment when screen loads
        document.addEventListener('DOMContentLoaded', () => {
            // Check if test-env screen is already active on page load
            const testEnvScreen = document.getElementById('screen-test-env');
            if (testEnvScreen && testEnvScreen.classList.contains('active')) {
                initTestEnvironment();
            }

            // Add screen change listener for test-env
            const testEnvLink = document.querySelector('a[data-screen="test-env"]');
            if (testEnvLink) {
                testEnvLink.addEventListener('click', () => {
                    setTimeout(initTestEnvironment, 100);
                });
            }
        });

        // Initialize test environment screen
        async function initTestEnvironment() {
            await verifyDatabaseConnections();
            await loadProductionUsers();
            await loadTestUsers();
        }

        // Verify both database connections
        async function verifyDatabaseConnections() {
            try {
                const response = await fetch('/api/admin/test-db/verify', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`Verification failed: ${response.status}`);
                }

                const data = await response.json();

                // Update production database status
                const prodStatus = document.getElementById('prod-db-status');
                const prodLatency = document.getElementById('prod-db-latency');
                if (data.production.connected) {
                    prodStatus.textContent = '‚úÖ Connected';
                    prodStatus.style.color = 'var(--macos-green)';
                    prodLatency.textContent = `Latency: ${data.production.latency}ms`;
                } else {
                    prodStatus.textContent = '‚ùå Disconnected';
                    prodStatus.style.color = 'var(--macos-red)';
                    prodLatency.textContent = 'Connection failed';
                }

                // Update test database status
                const testStatus = document.getElementById('test-db-status');
                const testLatency = document.getElementById('test-db-latency');
                if (data.test.configured) {
                    if (data.test.connected) {
                        testStatus.textContent = '‚úÖ Connected';
                        testStatus.style.color = 'var(--macos-green)';
                        testLatency.textContent = `Latency: ${data.test.latency}ms`;
                    } else {
                        testStatus.textContent = '‚ùå Disconnected';
                        testStatus.style.color = 'var(--macos-red)';
                        testLatency.textContent = 'Connection failed';
                    }
                } else {
                    testStatus.textContent = '‚ö†Ô∏è Not Configured';
                    testStatus.style.color = 'var(--macos-yellow)';
                    testLatency.textContent = 'DATABASE_URL_TEST missing';
                }

                // Update environment indicator
                const envIndicator = document.getElementById('current-env');
                const env = data.environment || 'unknown';
                envIndicator.textContent = env.charAt(0).toUpperCase() + env.slice(1);

                if (env === 'production') {
                    envIndicator.style.color = 'var(--macos-red)';
                } else if (env === 'preview') {
                    envIndicator.style.color = 'var(--macos-blue)';
                } else {
                    envIndicator.style.color = 'var(--macos-text-secondary)';
                }

            } catch (error) {
                console.error('Database verification error:', error);
                alert('Failed to verify database connections. Please check console for details.');
            }
        }

        // Copy schema from production to test
        async function copySchemaToTest() {
            const confirmed = confirm('‚ö†Ô∏è WARNING: This will DROP and recreate the test database schema.\n\nAll test data will be lost. Continue?');
            if (!confirmed) return;

            const btn = document.getElementById('copy-schema-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Copying schema...';

            try {
                const response = await fetch('/api/admin/test-db/copy-schema', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ confirm: true })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `Schema copy failed: ${response.status}`);
                }

                const result = await response.json();
                alert(`‚úÖ Schema copied successfully!\n\nTables created: ${result.tablesCreated}\nDuration: ${(result.duration / 1000).toFixed(2)}s`);

                // Refresh database status
                await verifyDatabaseConnections();

            } catch (error) {
                console.error('Schema copy error:', error);
                alert(`‚ùå Schema copy failed:\n${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Validate schema sync between production and test
        async function validateSchema() {
            const btn = document.getElementById('validate-schema-btn');
            const resultDiv = document.getElementById('schema-validation-result');
            const originalText = btn.textContent;

            btn.disabled = true;
            btn.textContent = 'Validating...';
            resultDiv.style.display = 'none';

            try {
                const response = await fetch('/api/admin/test-db/validate-schema', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `Schema validation failed: ${response.status}`);
                }

                const result = await response.json();

                resultDiv.style.display = 'block';

                if (result.schemasMatch) {
                    resultDiv.innerHTML = '<span style="color: var(--macos-green);">‚úÖ Schemas are in sync - safe to copy users</span>';
                } else {
                    const diff = result.differences;
                    let details = [];

                    if (diff.missingTablesInTest.length > 0) {
                        details.push(`Missing tables in test: ${diff.missingTablesInTest.join(', ')}`);
                    }
                    if (diff.extraTablesInTest.length > 0) {
                        details.push(`Extra tables in test: ${diff.extraTablesInTest.join(', ')}`);
                    }
                    if (diff.tableDifferences.length > 0) {
                        const tableNames = diff.tableDifferences.map(t => t.table).join(', ');
                        details.push(`Column differences in: ${tableNames}`);
                    }

                    resultDiv.innerHTML = `<span style="color: var(--macos-red);">‚ö†Ô∏è Schema mismatch detected</span><br><span style="color: var(--macos-text-secondary);">${details.join('<br>')}</span><br><strong>Recommendation:</strong> ${result.recommendation}`;
                }

            } catch (error) {
                console.error('Schema validation error:', error);
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<span style="color: var(--macos-red);">‚ùå Validation failed: ${error.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Clear test database
        async function clearTestDatabase() {
            const confirmed = confirm('‚ö†Ô∏è WARNING: This will delete ALL data from the test database.\n\nThe schema will be preserved, but all users, tasks, projects, etc. will be deleted.\n\nContinue?');
            if (!confirmed) return;

            const btn = document.getElementById('clear-db-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Clearing database...';

            try {
                const response = await fetch('/api/admin/test-db/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ confirm: true })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `Clear database failed: ${response.status}`);
                }

                const result = await response.json();
                alert(`‚úÖ Test database cleared!\n\nTables cleared: ${result.tablesCleared}\nRows deleted: ${result.totalRowsDeleted}`);

                // Refresh user lists
                await loadTestUsers();

            } catch (error) {
                console.error('Clear database error:', error);
                alert(`‚ùå Clear database failed:\n${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Load production users
        async function loadProductionUsers() {
            const container = document.getElementById('production-users-list');
            container.innerHTML = '<div style="padding: 30px; text-align: center; color: var(--macos-text-secondary);">Loading...</div>';

            try {
                const response = await fetch('/api/admin/production-users', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`Failed to load users: ${response.status}`);
                }

                const data = await response.json();
                renderProductionUsers(data.users);

            } catch (error) {
                console.error('Load production users error:', error);
                container.innerHTML = `<div style="padding: 30px; text-align: center; color: var(--macos-red);">Failed to load users: ${error.message}</div>`;
            }
        }

        // Render production users list
        function renderProductionUsers(users) {
            const container = document.getElementById('production-users-list');

            if (!users || users.length === 0) {
                container.innerHTML = '<div style="padding: 30px; text-align: center; color: var(--macos-text-secondary);">No production users found</div>';
                return;
            }

            let html = '<div style="padding: 0;">';
            users.forEach((user, index) => {
                const borderBottom = index < users.length - 1 ? 'border-bottom: 1px solid var(--macos-border);' : '';
                html += `
                    <div style="padding: 15px; display: flex; justify-content: space-between; align-items: center; ${borderBottom}">
                        <div>
                            <div style="font-weight: 600;">${escapeHtml(user.email)}</div>
                            <div style="font-size: 12px; color: var(--macos-text-secondary);">User ID: ${user.id}</div>
                        </div>
                        <button class="btn btn-primary" onclick="copyUserToTest('${escapeHtml(user.id)}', '${escapeHtml(user.email)}')" style="font-size: 12px; padding: 6px 12px;">
                            üìã Copy to Test
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // Load test database users
        async function loadTestUsers() {
            const container = document.getElementById('test-users-list');
            container.innerHTML = '<div style="padding: 30px; text-align: center; color: var(--macos-text-secondary);">Loading...</div>';

            try {
                const response = await fetch('/api/admin/test-db/users', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`Failed to load test users: ${response.status}`);
                }

                const data = await response.json();

                // Check if schema is not initialized
                if (data.schemaNotInitialized) {
                    container.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: var(--macos-text-secondary);">
                            <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                            <h3 style="margin: 0 0 8px 0; color: var(--macos-text-primary);">Test Database Not Initialized</h3>
                            <p style="margin: 0;">Click "Copy Schema" above to initialize the test database first.</p>
                        </div>
                    `;
                    return;
                }

                renderTestUsers(data.users);

            } catch (error) {
                console.error('Load test users error:', error);
                container.innerHTML = `<div style="padding: 30px; text-align: center; color: var(--macos-red);">Failed to load users: ${error.message}</div>`;
            }
        }

        // Render test users list
        function renderTestUsers(users) {
            const container = document.getElementById('test-users-list');

            if (!users || users.length === 0) {
                container.innerHTML = '<div style="padding: 30px; text-align: center; color: var(--macos-text-secondary);"><div style="font-size: 32px; margin-bottom: 10px;">üß™</div><div>No users in test database</div></div>';
                return;
            }

            let html = '<div style="padding: 0;">';
            users.forEach((user, index) => {
                const borderBottom = index < users.length - 1 ? 'border-bottom: 1px solid var(--macos-border);' : '';
                html += `
                    <div style="padding: 15px; display: flex; justify-content: space-between; align-items: center; ${borderBottom}">
                        <div>
                            <div style="font-weight: 600;">${escapeHtml(user.email)}</div>
                            <div style="font-size: 12px; color: var(--macos-text-secondary);">User ID: ${user.id}</div>
                        </div>
                        <button class="btn btn-danger" onclick="deleteTestUser('${escapeHtml(user.id)}', '${escapeHtml(user.email)}')" style="font-size: 12px; padding: 6px 12px;">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // Copy user from production to test
        async function copyUserToTest(userId, userEmail) {
            const confirmed = confirm(`Copy user "${userEmail}" to test database?\n\nThis will copy all their tasks, projects, contexts, attachments, and feedback.`);
            if (!confirmed) return;

            // Show loading indicator (save reference to dismiss later)
            const loadingToast = showToast('üìã Copying user to test database...', 'info', 0);

            try {
                const response = await fetch('/api/admin/test-db/copy-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ userId, confirm: true })
                });

                if (!response.ok) {
                    const error = await response.json();

                    // Dismiss loading toast
                    toast.dismiss(loadingToast);

                    if (response.status === 409) {
                        alert(`‚ö†Ô∏è User already exists in test database.\n\n${error.message}\n\nDelete the existing test user first before copying again.`);
                        return;
                    }

                    throw new Error(error.message || `Copy user failed: ${response.status}`);
                }

                const result = await response.json();

                // Dismiss loading toast
                toast.dismiss(loadingToast);

                // Show success toast
                showToast(`‚úÖ User copied successfully! (${result.stats.taken} tasks, ${result.stats.projecten} projects, ${result.stats.contexten} contexts)`, 'success', 5000);

                // Refresh test users list
                await loadTestUsers();

            } catch (error) {
                console.error('Copy user error:', error);
                // Dismiss loading toast
                toast.dismiss(loadingToast);
                showToast(`‚ùå Copy user failed: ${error.message}`, 'error', 5000);
            }
        }

        // Delete user from test database
        async function deleteTestUser(userId, userEmail) {
            const confirmed = confirm(`‚ö†Ô∏è Delete user "${userEmail}" from test database?\n\nThis will delete the user and all their related data (tasks, attachments, feedback, etc.).\n\nThis action cannot be undone.`);
            if (!confirmed) return;

            // Show loading indicator (save reference to dismiss later)
            const loadingToast = showToast('üóëÔ∏è Deleting user from test database...', 'info', 0);

            try {
                const response = await fetch(`/api/admin/test-db/user/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await response.json();
                    // Dismiss loading toast
                    toast.dismiss(loadingToast);
                    throw new Error(error.message || `Delete user failed: ${response.status}`);
                }

                const result = await response.json();

                // Dismiss loading toast
                toast.dismiss(loadingToast);

                // Show success toast
                showToast(`‚úÖ User deleted from test database! (${result.deletedTasks} tasks, ${result.deletedAttachments} attachments, ${result.deletedFeedback} feedback)`, 'success', 5000);

                // Refresh test users list
                await loadTestUsers();

            } catch (error) {
                console.error('Delete user error:', error);
                // Dismiss loading toast
                toast.dismiss(loadingToast);
                showToast(`‚ùå Delete user failed: ${error.message}`, 'error', 5000);
            }
        }

        // HTML escape helper
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================================================
        // PAGE HELP CONFIGURATION - Feature 062
        // ============================================================================

        // State voor page help editor
        let currentPageId = null;
        let currentPageHelpData = null;
        let previewDebounce = null;

        // Initialize page help event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const pageSelector = document.getElementById('page-help-selector');
            if (pageSelector) {
                pageSelector.addEventListener('change', handlePageSelection);
            }

            // Live preview op content textarea
            const contentTextarea = document.getElementById('page-help-content');
            if (contentTextarea) {
                contentTextarea.addEventListener('input', handleContentInput);
            }
        });

        // Handle page selection change
        function handlePageSelection(event) {
            const pageId = event.target.value;

            if (!pageId) {
                // No page selected - show empty state
                document.getElementById('page-help-editor-container').style.display = 'none';
                document.getElementById('page-help-no-selection').style.display = 'block';
                currentPageId = null;
                currentPageHelpData = null;
                return;
            }

            // Load page help content
            loadPageHelpContent(pageId);
        }

        // Load page help content voor selected page
        async function loadPageHelpContent(pageId) {
            try {
                // Show loading state
                document.getElementById('page-help-editor-container').style.display = 'none';
                document.getElementById('page-help-no-selection').innerHTML = '<p style="text-align:center; padding: 40px;">Loading...</p>';
                document.getElementById('page-help-no-selection').style.display = 'block';

                const response = await fetch(`/api/page-help/${pageId}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`Failed to load page help: ${response.status}`);
                }

                const data = await response.json();
                currentPageId = pageId;
                currentPageHelpData = data;

                // Update UI met loaded data
                updatePageHelpUI(data);

                // Hide no-selection state, show editor
                document.getElementById('page-help-no-selection').style.display = 'none';
                document.getElementById('page-help-editor-container').style.display = 'block';

            } catch (error) {
                console.error('Error loading page help:', error);
                alert('Failed to load page help content. Please try again.');

                // Reset selection
                document.getElementById('page-help-selector').value = '';
                document.getElementById('page-help-editor-container').style.display = 'none';
                document.getElementById('page-help-no-selection').style.display = 'block';
            }
        }

        // Update UI met page help data
        function updatePageHelpUI(data) {
            // Update status badge
            const statusBadge = document.getElementById('page-help-status-badge');
            if (data.isDefault) {
                statusBadge.textContent = 'Default';
                statusBadge.className = 'badge-feature';
            } else {
                statusBadge.textContent = 'Custom';
                statusBadge.className = 'badge-fix';
            }

            // Update modified info
            const modifiedInfo = document.getElementById('page-help-modified-info');
            if (data.modifiedAt && data.modifiedBy) {
                const date = new Date(data.modifiedAt);
                modifiedInfo.textContent = `Last modified: ${date.toLocaleDateString()} ${date.toLocaleTimeString()} by ${data.modifiedBy}`;
            } else {
                modifiedInfo.textContent = '';
            }

            // Update content textarea
            document.getElementById('page-help-content').value = data.content || '';

            // Update preview
            updatePreview(data.content || '');

            // Show/hide revert button (alleen tonen bij custom content)
            const revertBtn = document.getElementById('page-help-revert-btn');
            revertBtn.style.display = data.isDefault ? 'none' : 'inline-block';
        }

        // Handle content input (live preview met debounce)
        function handleContentInput(event) {
            const content = event.target.value;

            // Debounce preview update (500ms)
            clearTimeout(previewDebounce);
            previewDebounce = setTimeout(() => {
                updatePreview(content);
            }, 500);
        }

        // Update markdown preview
        function updatePreview(content) {
            const previewDiv = document.getElementById('page-help-preview');

            if (!content || content.trim() === '') {
                previewDiv.innerHTML = '<p style="color: var(--macos-text-secondary); font-style: italic;">Preview will appear here...</p>';
                return;
            }

            // Render markdown using marked.js (should be available globally)
            if (typeof marked !== 'undefined') {
                try {
                    const html = marked.parse(content);
                    previewDiv.innerHTML = html;
                } catch (error) {
                    console.error('Markdown parsing error:', error);
                    previewDiv.innerHTML = '<p style="color: red;">Error rendering markdown preview</p>';
                }
            } else {
                // Fallback: plain text met line breaks
                previewDiv.textContent = content;
            }
        }

        // Save page help content
        async function savePageHelpContent() {
            if (!currentPageId) {
                alert('No page selected');
                return;
            }

            const content = document.getElementById('page-help-content').value;

            // Validation: content moet niet leeg zijn
            if (!content || content.trim() === '') {
                alert('Content cannot be empty. Please enter help content or revert to default.');
                return;
            }

            // Disable save button tijdens save
            const saveBtn = document.getElementById('page-help-save-btn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'üíæ Saving...';

            try {
                const response = await fetch(`/api/page-help/${currentPageId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ content })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Save failed: ${response.status}`);
                }

                const result = await response.json();

                // Success feedback
                alert('‚úÖ Page help content saved successfully!');

                // Invalidate cache in main app (indien beschikbaar)
                if (window.opener && window.opener.pageHelpManager) {
                    window.opener.pageHelpManager.invalidateCache(currentPageId);
                } else if (window.pageHelpManager) {
                    window.pageHelpManager.invalidateCache(currentPageId);
                }

                // Broadcast cache invalidation via localStorage (werkt cross-tab)
                try {
                    const event = {
                        type: 'page-help-updated',
                        pageId: currentPageId,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('page-help-broadcast', JSON.stringify(event));
                    // Immediately remove it (we only need the storage event)
                    localStorage.removeItem('page-help-broadcast');
                } catch (e) {
                    console.warn('Failed to broadcast cache invalidation:', e);
                }

                // Reload content om updated data te tonen
                await loadPageHelpContent(currentPageId);

            } catch (error) {
                console.error('Error saving page help:', error);
                alert(`Failed to save page help content: ${error.message}`);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        // Revert to default content
        async function revertToDefault() {
            if (!currentPageId) {
                alert('No page selected');
                return;
            }

            if (!currentPageHelpData || currentPageHelpData.isDefault) {
                alert('This page is already using default content.');
                return;
            }

            // Confirm dialog
            const confirmed = confirm(`Are you sure you want to revert "${currentPageId}" help content to default?\n\nThis will delete your custom content and cannot be undone.`);
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch(`/api/page-help/${currentPageId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`Revert failed: ${response.status}`);
                }

                // Success feedback
                alert('‚úÖ Reverted to default content successfully!');

                // Invalidate cache in main app (indien beschikbaar)
                if (window.opener && window.opener.pageHelpManager) {
                    window.opener.pageHelpManager.invalidateCache(currentPageId);
                } else if (window.pageHelpManager) {
                    window.pageHelpManager.invalidateCache(currentPageId);
                }

                // Reload content
                await loadPageHelpContent(currentPageId);

            } catch (error) {
                console.error('Error reverting to default:', error);
                alert(`Failed to revert to default: ${error.message}`);
            }
        }

        // Refresh page help editor (reload current page)
        function refreshPageHelpEditor() {
            if (!currentPageId) {
                return;
            }
            loadPageHelpContent(currentPageId);
        }

        // ===== Revenue Detail Modal Functions =====

        // Global variable to store fetched revenue data
        let revenueDetailData = null;

        // Close revenue modal
        function closeRevenueModal() {
            document.getElementById('revenue-detail-modal').style.display = 'none';
            document.getElementById('revenue-modal-body').innerHTML = '';
        }

        // Close modal on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('revenue-detail-modal');
                if (modal && modal.style.display !== 'none') {
                    closeRevenueModal();
                }
            }
        });

        // Close modal on backdrop click
        document.getElementById('revenue-detail-modal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeRevenueModal();
            }
        });

        // Show loading spinner
        function showRevenueLoading() {
            document.getElementById('revenue-modal-body').innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 20px; color: #6b7280;">Loading details...</p>
                </div>
            `;
        }

        // Show error message
        function showRevenueError(message) {
            document.getElementById('revenue-modal-body').innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                    <h3 style="color: #ef4444; margin-bottom: 10px;">Error</h3>
                    <p style="color: #6b7280;">${message}</p>
                    <button onclick="window.closeRevenueModal()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">Close</button>
                </div>
            `;
        }

        // Show empty state
        function showRevenueEmpty(message, icon = 'üö´') {
            document.getElementById('revenue-modal-body').innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">${icon}</div>
                    <p style="color: #6b7280; font-size: 16px;">${message}</p>
                </div>
            `;
        }

        // Main function to show revenue details based on card type
        window.showRevenueDetails = async function(cardType) {
            const modal = document.getElementById('revenue-detail-modal');
            const titleEl = document.getElementById('revenue-modal-title');

            // Show modal
            modal.style.display = 'flex';

            // Set title based on card type
            const titles = {
                'mrr': 'Monthly Recurring Revenue Details',
                'arr': 'Annual Recurring Revenue Details',
                'active': 'Active Subscriptions Details',
                'premium': 'Premium Revenue Details',
                'enterprise': 'Enterprise Revenue Details',
                'free': 'Free Tier Details'
            };
            titleEl.textContent = titles[cardType] || 'Revenue Details';

            // Show loading
            showRevenueLoading();

            try {
                if (cardType === 'mrr') {
                    // MRR fetches revenue stats from API
                    await renderMRRDetails();
                } else if (cardType === 'arr') {
                    // ARR fetches revenue stats from API
                    await renderARRDetails();
                } else if (cardType === 'active' || cardType === 'premium' || cardType === 'enterprise') {
                    // Fetch active subscriptions data
                    const response = await fetch('/api/admin2/revenue/active-subscriptions?sort=revenue');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const data = await response.json();
                    revenueDetailData = data;

                    if (cardType === 'active') {
                        renderActiveSubscriptions(data);
                    } else if (cardType === 'premium') {
                        renderPremiumRevenue(data);
                    } else if (cardType === 'enterprise') {
                        renderEnterpriseRevenue(data);
                    }
                } else if (cardType === 'free') {
                    // Fetch free tier stats
                    const response = await fetch('/api/admin2/revenue/free-tier');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const data = await response.json();
                    renderFreeTierStats(data);
                }
            } catch (error) {
                console.error('Error fetching revenue details:', error);
                showRevenueError('Failed to load revenue details. Please try again.');
            }
        }

        // Render MRR breakdown (fetches revenue stats from API)
        async function renderMRRDetails() {
            try {
                const response = await fetch('/api/admin2/stats/revenue');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();

                const byTier = data.by_tier || [];
                const totalMRR = data.mrr || 0;

            if (byTier.length === 0) {
                showRevenueEmpty('No active subscriptions yet.', 'üìä');
                return;
            }

            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #e5e7eb; text-align: left;">
                            <th style="padding: 12px; font-weight: 600;">Plan Type</th>
                            <th style="padding: 12px; font-weight: 600; text-align: right;">Users</th>
                            <th style="padding: 12px; font-weight: 600; text-align: right;">Price/Month</th>
                            <th style="padding: 12px; font-weight: 600; text-align: right;">Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            byTier.forEach(tier => {
                html += `
                    <tr style="border-bottom: 1px solid #f3f4f6;">
                        <td style="padding: 12px;">${tier.tier}</td>
                        <td style="padding: 12px; text-align: right;">${tier.user_count}</td>
                        <td style="padding: 12px; text-align: right;">‚Ç¨${tier.price_monthly.toFixed(2)}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">‚Ç¨${tier.revenue.toFixed(2)}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                    <tfoot>
                        <tr style="border-top: 2px solid #e5e7eb; font-weight: 600;">
                            <td colspan="3" style="padding: 12px;">Total MRR</td>
                            <td style="padding: 12px; text-align: right; color: #10b981; font-size: 18px;">‚Ç¨${totalMRR.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>

                <div style="margin-top: 40px;">
                    <h3 style="margin-bottom: 20px; color: #111827;">MRR Trend - Last 52 Weeks</h3>
                    <div style="position: relative; height: 300px;">
                        <canvas id="year-chart-mrr"></canvas>
                    </div>
                </div>
            `;

                document.getElementById('revenue-modal-body').innerHTML = html;

                // Render year chart after DOM update
                await window.renderYearChart('mrr');
            } catch (error) {
                console.error('Error fetching MRR details:', error);
                showRevenueError('Failed to load MRR details. Please try again.');
            }
        }

        // Render ARR breakdown (fetches revenue stats from API)
        async function renderARRDetails() {
            try {
                const response = await fetch('/api/admin2/stats/revenue');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();

                const byTier = data.by_tier || [];
                const totalARR = data.arr || 0;

                // Filter only yearly plans
                const yearlyPlans = byTier.filter(tier => tier.interval === 'yearly');

                if (yearlyPlans.length === 0) {
                    showRevenueEmpty('No annual subscriptions yet.', 'üìÖ');
                    return;
                }

                let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #e5e7eb; text-align: left;">
                            <th style="padding: 12px; font-weight: 600;">Plan Type</th>
                            <th style="padding: 12px; font-weight: 600; text-align: right;">Users</th>
                            <th style="padding: 12px; font-weight: 600; text-align: right;">Price/Year</th>
                            <th style="padding: 12px; font-weight: 600; text-align: right;">Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

                yearlyPlans.forEach(tier => {
                    const yearlyRevenue = tier.user_count * tier.price;
                    html += `
                    <tr style="border-bottom: 1px solid #f3f4f6;">
                        <td style="padding: 12px;">${tier.tier}</td>
                        <td style="padding: 12px; text-align: right;">${tier.user_count}</td>
                        <td style="padding: 12px; text-align: right;">‚Ç¨${tier.price.toFixed(2)}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">‚Ç¨${yearlyRevenue.toFixed(2)}</td>
                    </tr>
                `;
                });

                html += `
                    </tbody>
                    <tfoot>
                        <tr style="border-top: 2px solid #e5e7eb; font-weight: 600;">
                            <td style="padding: 12px;">Total ARR</td>
                            <td style="padding: 12px;"></td>
                            <td style="padding: 12px;"></td>
                            <td style="padding: 12px; text-align: right;">‚Ç¨${totalARR.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>

                <div style="margin-top: 40px;">
                    <h3 style="margin-bottom: 20px; color: #111827;">ARR Trend - Last 52 Weeks</h3>
                    <div style="position: relative; height: 300px;">
                        <canvas id="year-chart-arr"></canvas>
                    </div>
                </div>
            `;

                document.getElementById('revenue-modal-body').innerHTML = html;

                // Render year chart after DOM update
                await window.renderYearChart('arr');
            } catch (error) {
                console.error('Error fetching ARR details:', error);
                showRevenueError('Failed to load ARR details. Please try again.');
            }
        }

        // Render active subscriptions list
        async function renderActiveSubscriptions(data) {
            if (data.subscriptions.length === 0) {
                showRevenueEmpty('No paying customers yet.', 'üë•');
                return;
            }

            let html = `
                <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <p style="color: #6b7280; margin: 0;">Total: ${data.total_count} active subscriptions</p>
                    <select id="revenue-sort" onchange="changeSortOrder()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer;">
                        <option value="revenue">Sort by Revenue</option>
                        <option value="email">Sort by Email</option>
                        <option value="date">Sort by Date</option>
                    </select>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #e5e7eb; text-align: left;">
                            <th style="padding: 12px; font-weight: 600;">Email</th>
                            <th style="padding: 12px; font-weight: 600;">Name</th>
                            <th style="padding: 12px; font-weight: 600;">Plan</th>
                            <th style="padding: 12px; font-weight: 600; text-align: right;">Amount/Month</th>
                            <th style="padding: 12px; font-weight: 600;">Started</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.subscriptions.forEach(sub => {
                const createdDate = new Date(sub.created_at).toLocaleDateString('nl-NL');
                const naam = sub.naam || sub.email.split('@')[0];
                html += `
                    <tr onclick="openUserDetail('${sub.user_id}')" style="border-bottom: 1px solid #f3f4f6; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                        <td style="padding: 12px;">${sub.email}</td>
                        <td style="padding: 12px;">${naam}</td>
                        <td style="padding: 12px;"><span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">${sub.selected_plan}</span></td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">‚Ç¨${sub.monthly_amount.toFixed(2)}</td>
                        <td style="padding: 12px; color: #6b7280;">${createdDate}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>

                <div style="margin-top: 40px;">
                    <h3 style="margin-bottom: 20px; color: #111827;">Active Subscriptions Trend - Last 52 Weeks</h3>
                    <div style="position: relative; height: 300px;">
                        <canvas id="year-chart-active"></canvas>
                    </div>
                </div>
            `;

            document.getElementById('revenue-modal-body').innerHTML = html;

            // Render year chart after DOM update
            await renderYearChart('active');
        }

        // Render premium revenue (filtered monthly plans)
        function renderPremiumRevenue(data) {
            const premiumSubs = data.subscriptions.filter(s =>
                s.selected_plan === 'monthly_7' || s.selected_plan === 'monthly_8'
            );

            if (premiumSubs.length === 0) {
                showRevenueEmpty('No monthly subscriptions yet.', '‚≠ê');
                return;
            }

            const monthly7Count = premiumSubs.filter(s => s.selected_plan === 'monthly_7').length;
            const monthly8Count = premiumSubs.filter(s => s.selected_plan === 'monthly_8').length;

            let html = `
                <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #374151;">Premium Breakdown</h3>
                    <p style="margin: 0; color: #6b7280;">${monthly7Count} users on ‚Ç¨7/mo, ${monthly8Count} users on ‚Ç¨8/mo</p>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #e5e7eb; text-align: left;">
                            <th style="padding: 12px; font-weight: 600;">Email</th>
                            <th style="padding: 12px; font-weight: 600;">Name</th>
                            <th style="padding: 12px; font-weight: 600;">Plan</th>
                            <th style="padding: 12px; font-weight: 600; text-align: right;">Amount/Month</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            premiumSubs.forEach(sub => {
                const naam = sub.naam || sub.email.split('@')[0];
                html += `
                    <tr onclick="openUserDetail('${sub.user_id}')" style="border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                        <td style="padding: 12px;">${sub.email}</td>
                        <td style="padding: 12px;">${naam}</td>
                        <td style="padding: 12px;"><span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">${sub.selected_plan}</span></td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">‚Ç¨${sub.monthly_amount.toFixed(2)}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            document.getElementById('revenue-modal-body').innerHTML = html;
        }

        // Render enterprise revenue (filtered yearly plans)
        function renderEnterpriseRevenue(data) {
            const enterpriseSubs = data.subscriptions.filter(s =>
                s.selected_plan === 'yearly_70' || s.selected_plan === 'yearly_80'
            );

            if (enterpriseSubs.length === 0) {
                showRevenueEmpty('No yearly subscriptions yet.', 'üíé');
                return;
            }

            const yearly70Count = enterpriseSubs.filter(s => s.selected_plan === 'yearly_70').length;
            const yearly80Count = enterpriseSubs.filter(s => s.selected_plan === 'yearly_80').length;

            let html = `
                <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #374151;">Enterprise Breakdown</h3>
                    <p style="margin: 0; color: #6b7280;">${yearly70Count} users on ‚Ç¨70/year, ${yearly80Count} users on ‚Ç¨80/year</p>
                    <p style="margin: 5px 0 0 0; color: #9ca3af; font-size: 14px;">Monthly amounts shown below are normalized (yearly/12)</p>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #e5e7eb; text-align: left;">
                            <th style="padding: 12px; font-weight: 600;">Email</th>
                            <th style="padding: 12px; font-weight: 600;">Name</th>
                            <th style="padding: 12px; font-weight: 600;">Plan</th>
                            <th style="padding: 12px; font-weight: 600; text-align: right;">Amount/Month</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            enterpriseSubs.forEach(sub => {
                const naam = sub.naam || sub.email.split('@')[0];
                html += `
                    <tr onclick="openUserDetail('${sub.user_id}')" style="border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                        <td style="padding: 12px;">${sub.email}</td>
                        <td style="padding: 12px;">${naam}</td>
                        <td style="padding: 12px;"><span style="background: #e0e7ff; color: #3730a3; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">${sub.selected_plan}</span></td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">‚Ç¨${sub.monthly_amount.toFixed(2)}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            document.getElementById('revenue-modal-body').innerHTML = html;
        }

        // Render free tier statistics
        function renderFreeTierStats(data) {
            if (data.free_users === 0) {
                showRevenueEmpty('No free users yet.', 'üÜì');
                return;
            }

            const html = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">Free Users</div>
                        <div style="font-size: 32px; font-weight: 700; color: #374151;">${data.free_users}</div>
                    </div>
                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">Recent Signups (30d)</div>
                        <div style="font-size: 32px; font-weight: 700; color: #374151;">${data.recent_signups_30d}</div>
                    </div>
                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">Active Trials</div>
                        <div style="font-size: 32px; font-weight: 700; color: #374151;">${data.active_trials}</div>
                    </div>
                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">Conversion Opportunities</div>
                        <div style="font-size: 32px; font-weight: 700; color: #374151;">${data.conversion_opportunities}</div>
                        <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">Free users with recent task activity</div>
                    </div>
                </div>
                <div style="background: #fef3c7; padding: 16px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <p style="margin: 0; color: #92400e; font-size: 14px;"><strong>Note:</strong> Free tier generates no revenue</p>
                </div>
            `;

            document.getElementById('revenue-modal-body').innerHTML = html;
        }

        // Change sort order (re-fetch with new sort parameter)
        async function changeSortOrder() {
            const sortValue = document.getElementById('revenue-sort').value;
            showRevenueLoading();

            try {
                const response = await fetch(`/api/admin2/revenue/active-subscriptions?sort=${sortValue}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                revenueDetailData = data;

                // Re-render with current card type (determined by modal title)
                const title = document.getElementById('revenue-modal-title').textContent;
                if (title.includes('Active Subscriptions')) {
                    renderActiveSubscriptions(data);
                } else if (title.includes('Premium')) {
                    renderPremiumRevenue(data);
                } else if (title.includes('Enterprise')) {
                    renderEnterpriseRevenue(data);
                }

                // Set sort dropdown to correct value
                document.getElementById('revenue-sort').value = sortValue;
            } catch (error) {
                console.error('Error changing sort:', error);
                showRevenueError('Failed to sort data. Please try again.');
            }
        }

        // Open user detail panel (click-through from revenue modal)
        function openUserDetail(userId) {
            closeRevenueModal();
            // Use existing Screens.showUserDetails function if available
            if (window.Screens && typeof Screens.showUserDetails === 'function') {
                Screens.showUserDetails(userId);
            } else {
                console.warn('Screens.showUserDetails not available');
            }
        }

        // NOTE: attachRevenueClickHandlers is now defined in admin2.js
        // This ensures it's available early and calls window.showRevenueDetails correctly

    </script>

</body>
</html>
